(()=>{"use strict";const t={context:null,hasToExit:!1,width:1024,height:793,mainScreenWidth:896,mainScreenHeight:672,topMenuHeight:25,tileSize:16,menuFont:"30px Arial",buttonFont:"22px Arial",normalFont:"14px Arial",backgroundColor:"#000",textColor:"#FFF",highlightColor:"#F00",verticalButtonSize:44,minTileSize:function(){return 8},mediumTileSize:function(){return 16},maxTileSize:function(){return 32},horizontalTilesToShow:function(){return~~(t.mainScreenWidth/t.tileSize)},verticalTilesToShow:function(){return~~(t.mainScreenHeight/t.tileSize)},bottomOfMap:function(){return t.topMenuHeight+t.mainScreenHeight},rightMenuSize:function(){return t.width-t.mainScreenWidth},lowerMenuSize:function(){return t.height-t.bottomOfMap()},fontHeight:function(){return parseInt(t.context.font.match(/\d+/))}},e=t,i={keyboard:{aux:{}},mouse:{x:0,y:0,clicked:!1,mainWindowClicked:!1,rightMenuClicked:!1,lowerMenuClicked:!1,miniMapClicked:!1,reset:function(){i.mouse.clicked=!1,i.mouse.mainWindowClicked=!1,i.mouse.rightMenuClicked=!1,i.mouse.lowerMenuClicked=!1,i.mouse.miniMapClicked=!1}},init:function(){i.keyboard.ARROW_LEFT=new o(37),i.keyboard.ARROW_UP=new o(38),i.keyboard.ARROW_RIGHT=new o(39),i.keyboard.ARROW_DOWN=new o(40),i.keyboard.ENTER=new o(13),i.keyboard.ALT=new o(18),i.keyboard.ESC=new o(27),i.keyboard.SPACE=new o(32),i.keyboard.O=new o(79),i.keyboard.C=new o(67),i.keyboard.V=new o(86),i.keyboard.T=new o(84)},keyDown:function(t){var e=i.keyboard.aux[t];e&&e.keyDown()},mouseClick:function(t,o){i.mouse.clicked=!0,i.mouse.x=t,i.mouse.y=o,i.mouse.x<e.mainScreenWidth?i.mouse.y>e.bottomOfMap()?i.mouse.lowerMenuClicked=!0:i.mouse.y>e.topMenuHeight&&(i.mouse.mainWindowClicked=!0):i.mouse.y>=e.bottomOfMap()?i.mouse.miniMapClicked=!0:i.mouse.rightMenuClicked=!0},resetKeyboard:function(){Object.keys(i.keyboard).forEach(((t,e)=>{i.keyboard[t].execute&&i.keyboard[t].execute()}))}};function o(t){this.isPressed=!1,this.keyCode=t,i.keyboard.aux[t]=this}o.prototype.keyDown=function(){this.isPressed=!0},o.prototype.execute=function(){return!!this.isPressed&&(this.isPressed=!1,!0)};const n=i,r={language:"en",en:{mainMenu:{start:"Start",options:"Options",exit:"Exit"},optionsMenu:{language:"Language",tileSize:"Tile Size",little:"Little",medium:"Medium",big:"Big"},resources:{mineral:"mineral",gas:"gas",fish:"fish",hervibore:"hervibore"},general:{back:"Back",nextTurn:"Next turn",move:"Move",fortify:"Fortify",mine:"Mine",cancel:"Cancel",robots:"Robot",construction:"Construction robot"}},es:{mainMenu:{start:"Empezar",options:"Opciones",exit:"Salir"},optionsMenu:{language:"Idioma",tileSize:"Tamaño de cuadricula",little:"Pequeño",medium:"Mediano",big:"Grande"},resources:{mineral:"mineral",gas:"gas",fish:"peces",hervibore:"hervíboros"},general:{back:"volver",nextTurn:"Siguiente turno",move:"Mover",fortify:"Fortificar",mine:"Mina",cancel:"Cancelar",robots:"Robot",construction:"Robot de construccion"}},getText:function(t,e){return r[r.language][t][e]}},s=r,a={gradient:0,getGrey:function(t){return Math.lerp(0,255,t)},updateGradient:function(t){a.gradient=.5*Math.sin(.003*t)+.5},readUserLanguage:function(){if(navigator&&navigator.languages)for(var t in navigator.languages)for(var e in s)if(e==navigator.languages[t])return void(s.language=e)}};Math.lerp=function(t,e,i){return t+i*(e-t)},Math.tileDistance=function(t,e,i,o){return Math.abs(t-i)+Math.abs(e-o)};const l=a;function h(t,e){this.x=t,this.y=e}h.prototype.equals=function(t){return this.x==t.x&&this.y==t.y},h.prototype.distance=function(t){return Math.abs(this.x-t.x)+Math.abs(this.y-t.y)},h.prototype.neighbors=function(){return[new h(this.x+1,this.y),new h(this.x-1,this.y),new h(this.x,this.y+1),new h(this.x,this.y-1)]};const c=h;function u(t,e,i){c.call(this,t,e),this.worldMap=i}u.prototype=Object.create(c.prototype),u.prototype.neighbors=function(){let t=[];var e=this.worldMap.options;return t.push(new u((this.x+1+e.width)%e.width,this.y,this.worldMap)),t.push(new u((this.x-1+e.width)%e.width,this.y,this.worldMap)),this.y>0&&t.push(new u(this.x,this.y-1,this.worldMap)),this.y<e.height-1&&t.push(new u(this.x,this.y+1,this.worldMap)),t},u.prototype.movementCost=function(){return this.worldMap.map[this.x][this.y].movementCost()},u.prototype.distance=function(t){let e=Math.abs(t.x-this.x),i=this.worldMap.options.width-e;return e=e>i?i:e,e+Math.abs(t.y-this.y)};const p=u;function d(t,e,i,o,n){this.parent=t,this.heightSeed=e,this.humiditySeed=i,this.height=.5*this.heightSeed+.5,this.type=this.tileType(this.parent.options.waterHeight),this.water=this.height<this.parent.options.waterHeight,this.resource=null,this.building=null,this.unit=null,this.pos=new p(o,n,t)}d.prototype.tileTypes={deepOcean:{color:"#072253"},ocean:{color:"#12326E"},shallowWaters:{color:"#1F4487"},beach:{color:"#FFCF75"},highMountain:{color:"#7A0009"},desert:{color:"#E2AB46"},grass:{color:"#71D361"},forest:{color:"#1B880A"},desertMountain:{color:"#7D5100"},grassMountain:{color:"#4BBB3A"},forestMountain:{color:"#0E6700"}},d.prototype.tileType=function(t){if(this.height<t-.25)return"deepOcean";if(this.height<t-.05)return"ocean";if(this.height<t)return"shallowWaters";if(this.height<t+.013)return"beach";if(this.height>.85)return"highMountain";var e=.8-t;return this.height<.6*e+t?this.humiditySeed<-.4?"desert":this.humiditySeed<.5?"grass":"forest":this.humiditySeed<-.4?"desertMountain":this.humiditySeed<.5?"grassMountain":"forestMountain"},d.prototype.mapColor=function(){return this.tileTypes[this.type].color},d.prototype.heightGray=function(){var t=l.getGrey(this.height);return"rgb("+t+","+t+","+t+")"},d.prototype.humidityGray=function(){var t=l.getGrey(.5*this.humiditySeed+.5);return"rgb("+t+","+t+","+t+")"},d.prototype.texture=function(){return F.textures.mapTile[this.type]},d.prototype.movementCost=function(){return this.water?10:1},d.prototype.getState=function(){return null!==this.unit&&null!==this.building?this.parent.superiorSideTile?this.unit:this.building:null!==this.unit?this.unit:null!==this.building?this.building:null},d.prototype.centerView=function(){this.parent.centerView(this.pos.x,this.pos.y)};const f=d,g={generateResource:function(t,i,o,n,r,s){var a,l,h,c=0,u=t.mapCanvas.getContext("2d");for(a=0;a<r.length;a++)c+=t.stats[r[a]];for(c=~~(c*s);c>0;)a=~~(Math.random()*t.options.width),l=~~(Math.random()*t.options.height),(h=t.map[a][l]).resource||-1==r.indexOf(h.type)||h.building||(c--,h.resource=i.resources[n],u.drawImage(F.textures[o][n],a*e.maxTileSize(),l*e.maxTileSize(),e.maxTileSize(),e.maxTileSize()))}},y={resources:{MINERAL:{color:"#DC444F",text:"mineral",default:100,proportion:.0075,terrain:["grass","grassMountain","forest"]},GAS:{color:"#CB8F1E",text:"gas",default:10,proportion:.005,terrain:["deepOcean","ocean"]},GRASSLIFE:{color:"#5774AA",text:"hervibore",default:25,proportion:.005,terrain:["grass","grassMountain","forest"]},SEALIFE:{color:"#FFF",text:"fish",default:50,proportion:.0075,terrain:["deepOcean","ocean"]}},generateResources:function(t){var e,i;for(e in y.resources)i=y.resources[e],g.generateResource(t,y,"naturalResources",e,i.terrain,i.proportion)}},m=y,w={reset:()=>{let t,e,i,o=[w.root],n=[];for(;o.length>0;){for(e in t=o.shift(),t.completion=0,t.children)i=t.children[e],n.includes(i)||o.push(i);n.push(t)}}},x=w,S={name:"initial_technology",cost:10,completed:()=>{console.log("first technology",void 0)},parents:[]},v={name:"final_technology",cost:100,completed:()=>{console.log("final technology",void 0)},parents:[{name:"adv_mineral_technology",cost:50,completed:()=>{console.log("advanced mineral technology",void 0)},parents:[{name:"mineral_technology",cost:20,completed:()=>{console.log("mineral technology",void 0)},parents:[S]}]},{name:"robots_technology",cost:50,completed:()=>{console.log("robots technology",void 0)},parents:[S]}]};w.root=S,w.end=v;let b=w.end;b.children=[],b.level=0;let T,M,k,C,z=[b];for(;z.length>0;)for(M in T=z.shift(),T.parents)k=T.parents[M],C=T.position+1,k.children?(k.children.push(T),k.level<T.level+1&&(k.level=T.level+1)):(k.children=[T],k.level=T.level+1,z.push(k));let R=[];for(M=0;M<=w.root.level;M++)R[M]=0;z=[w.root];let O,A=[];for(;z.length>0;)for(M in T=z.shift(),A.push(T),T.levelPos=R[T.level]++,T.children)O=T.children[M],A.includes(O)||z.includes(O)||z.push(O);const E={textures:[],tileSize:100,load:function(){E.textures.mapTile=function(){let t,e,i=[];for(t in f.prototype.tileTypes)e=L(E.tileSize,E.tileSize),W(e,f.prototype.tileTypes[t].color),i[t]=e;return i}(),E.textures.userResources=function(){let t,e=[];return t=L(E.tileSize,E.tileSize),function(t,e,i){var o=t.getContext("2d");o.fillStyle="#FF0",o.beginPath(),o.moveTo(0,0),o.lineTo(e/2,e),o.lineTo(e,0),o.closePath(),o.fill()}(t,E.tileSize),e.construction=t,e}(),E.textures.naturalResources=function(){let t,e,i=[];for(t in m.resources)e=L(E.tileSize,E.tileSize),B(e,E.tileSize,m.resources[t].color),i[t]=e;return i}(),E.textures.buildings=function(){let t,e=[];return t=L(E.tileSize,E.tileSize),function(t,e,i){var o=t.getContext("2d");o.fillStyle="#FFF",o.beginPath(),o.moveTo(0,e/2-10),o.lineTo(0,e/2+10),o.lineTo(e,e/2+10),o.lineTo(e,e/2-10),o.closePath(),o.fill(),o.beginPath(),o.moveTo(e/2-10,0),o.lineTo(e/2+10,0),o.lineTo(e/2+10,e),o.lineTo(e/2-10,e),o.closePath(),o.fill()}(t,E.tileSize),e.mine=t,e}(),E.textures.general=function(){let t,e=[];return t=L(E.tileSize,E.tileSize),function(t,e,i){var o=t.getContext("2d");o.fillStyle="#0FF",o.beginPath(),o.moveTo(0,e),o.lineTo(e/2,0),o.lineTo(e,e),o.closePath(),o.fill()}(t,E.tileSize),e.city=t,e}(),E.textures.research=function(){let t,i,o,n,r,s,a=[],l=300,h=x.root,c=h.level+1;i=L(c*l,e.mainScreenHeight);let u=i.getContext("2d");for(u.font=e.buttonFont,t=0;t<c;t++)u.fillStyle=t%2?"#CB8F1E":"#FFCF75",u.fillRect(t*l,0,l,e.mainScreenHeight);let p=[h],d=[];for(;p.length>0;)for(t in r=p.shift(),d.push(r),o=(c-r.level-1)*l+15,n=115*r.levelPos,u.fillStyle="#FFF",u.fillRect(o,n,270,100),u.fillStyle="#000",u.fillText(r.name,o+5,n+20),r.children)s=r.children[t],d.includes(s)||p.includes(s)||p.push(s);return a.tree=i,a}()}};function L(t,e){var i=document.createElement("canvas");return i.width=t,i.height=e,i}function W(t,e){var i=t.getContext("2d");i.fillStyle=e,i.fillRect(0,0,t.width,t.height)}function B(t,e,i){var o=t.getContext("2d");o.fillStyle=i,o.beginPath(),o.moveTo(0,e/2),o.lineTo(e/2,e),o.lineTo(e,e/2),o.lineTo(e/2,0),o.closePath(),o.fill()}const F=E,H={stack:[],screenExists:function(){return this.stack.length>0},addScreen:function(t){n.keyboard.ENTER.execute(),this.stack.unshift(t)},removeScreen:function(){return n.keyboard.ENTER.execute(),this.stack.shift()},draw:function(){this.stack[0].draw()},update:function(t){this.stack[0].update(t)}};function I(){this.selectedOption=0,this.optionArray=[]}I.prototype.update=function(t){n.keyboard.ESC.execute()&&H.screenExists()&&H.removeScreen(),n.keyboard.ENTER.execute()&&this.optionArray[this.selectedOption].execute(),n.keyboard.ARROW_UP.execute()&&(this.selectedOption=(this.selectedOption+this.optionArray.length-1)%this.optionArray.length),n.keyboard.ARROW_DOWN.execute()&&(this.selectedOption=(this.selectedOption+1)%this.optionArray.length),n.keyboard.ARROW_RIGHT.execute()&&this.optionArray[this.selectedOption].nextOption(),n.keyboard.ARROW_LEFT.execute()&&this.optionArray[this.selectedOption].previousOption()},I.prototype.padding=2,I.prototype.draw=function(){var t=e.context;t.fillStyle=e.backgroundColor,t.fillRect(0,0,e.width,e.height),t.fillStyle=e.textColor,t.font=e.menuFont;var i,o,n=e.fontHeight(),r=(n+2*this.padding)*this.optionArray.length,s=(e.height-r)/2+this.padding+n;for(var a in this.optionArray){if(i=this.optionArray[a].getText(this.section),o=t.measureText(i).width,this.selectedOption==a){var h=Math.lerp(0,128,l.gradient);t.fillStyle="rgb(255,"+h+","+h+")",t.fillText(i,(e.width-o)/2,s),t.fillStyle=e.textColor}else t.fillText(i,(e.width-o)/2,s);s+=2*this.padding+n}},I.prototype.addButton=function(t,e){this.optionArray.push(new Y(t,e))},I.prototype.addSelection=function(t,i,o){var n=e[o];for(var r in i)if(i[r].value==n)return void this.optionArray.push(new j(t,i,r,o))},I.prototype.addLanguageSelection=function(){var t=s.language,e=[{value:"en",text:"English"},{value:"es",text:"Español"}];for(var i in e)if(e[i].value==t)return void this.optionArray.push(new q(e,i))};const V=I;function P(t){this.text=t}function Y(t,e){P.call(this,t),this.function_pointer=e}function j(t,e,i,o){P.call(this,t),this.options=e,this.selectedOption=i,this.attribute=o}function q(t,e){j.call(this,"language",t,e)}function _(){V.call(this),this.section="optionsMenu",this.addSelection("tileSize",[{value:e.minTileSize(),text:"little"},{value:e.mediumTileSize(),text:"medium"},{value:e.maxTileSize(),text:"big"}],"tileSize"),this.addLanguageSelection()}P.prototype.getText=function(t){return s.getText(t,this.text)},P.prototype.execute=function(){},P.prototype.nextOption=function(){},P.prototype.previousOption=function(){},Y.prototype=Object.create(P.prototype),Y.prototype.execute=function(){this.function_pointer()},j.prototype=Object.create(P.prototype),j.prototype.changeValue=function(){e[this.attribute]=this.options[this.selectedOption].value},j.prototype.nextOption=function(){this.selectedOption=(this.selectedOption+1)%this.options.length,this.changeValue()},j.prototype.previousOption=function(){this.selectedOption=(this.options.length+this.selectedOption-1)%this.options.length,this.changeValue()},j.prototype.getText=function(t){return"<- "+s.getText(t,this.text)+" : "+s.getText(t,this.options[this.selectedOption].text)+" ->"},q.prototype=Object.create(j.prototype),q.prototype.changeValue=function(){s.language=this.options[this.selectedOption].value},q.prototype.getText=function(t){return"<- "+s.getText(t,this.text)+" : "+this.options[this.selectedOption].text+" ->"},_.prototype=Object.create(V.prototype);const X=_,G={resources:{},init:()=>{G.resources=Object.assign(G.getResourcesObject(),{MINERAL:100})},getResourcesObject:()=>{let t={construction:0};for(var e in m.resources)t[e]=0;return t},addResources:t=>{for(let e in t)G.resources[e]+=t[e]},removeResources:t=>{for(let e in t)G.resources[e]-=t[e]},checkAvailable:t=>{for(var e in t)if(t[e]>G.resources[e])return!1;return!0}},U=G,N={list:{robot:[]},unitsWaiting:()=>N.list.robot.filter((t=>t.isWaiting())),addRobot:function(t){N.list.robot.push(t),U.resources.construction++},reset:function(){N.list.robot=[]}},D=N;function K(){this.nextState=null}K.prototype.changeState=function(t){if(null!=this.nextState){this.nextState.select();var e=this.nextState;this.nextState=null,t.currentState=e,n.resetKeyboard()}},K.prototype.update=function(){},K.prototype.draw=function(){},K.prototype.select=function(){};const Z=K;function Q(t,e,i){Z.call(this),this.worldMap=t,this.pos=e,this.tile=i,this.tile.building=this,this.level=1,this.turnsBuilt=0}Q.prototype=Object.create(Z.prototype),Q.prototype.getResources=U.getResourcesObject,Q.prototype.getCost=U.getResourcesObject,Q.prototype.turnsToBuild=null,Q.prototype.draw=function(){this.worldMap.drawBackground(),this.worldMap.drawUnits()},Q.prototype.update=function(t){n.mouse.mainWindowClicked&&this.unSelect()},Q.prototype.select=function(){this.worldMap.centerView(this.pos.x,this.pos.y)},Q.prototype.unSelect=function(){this.nextState=this.worldMap},Q.prototype.texture=function(){return F.textures.buildings[this.type]};const J=Q;function $(t,e,i){J.call(this,t,e,i)}$.prototype=Object.create(J.prototype),$.prototype.type="mine",$.prototype.getResources=()=>Object.assign(J.prototype.getResources.call(void 0),{MINERAL:10}),$.prototype.getCost=()=>Object.assign(J.prototype.getResources.call(void 0),{MINERAL:100}),J.prototype.turnsToBuild=4;const tt=$,et={buildings:[],queue:[],buildMine:function(t){let e,i=tt.prototype.getCost();for(e in i)U.resources[e]-=i[e];t.state="BUILD";var o=new tt(t.worldMap,t.pos,t.getTile());et.queue.push(o)},reset:function(){et.buildings=[],et.queue=[]}},it=et;function ot(t,e,i,o,n=5,r=5){this.left=t,this.top=e,this.width=i,this.height=o,this.marginLeft=n,this.marginTop=r}ot.prototype.advanceHor=function(){this.left+=this.width+this.marginLeft},ot.prototype.advanceVer=function(){this.top+=this.height+this.marginTop},ot.prototype.getRect=function(){return{x0:this.left,x1:this.left+this.width,y0:this.top,y1:this.top+this.height}};const nt=ot;function rt(t,e,i=!1){this.control=t,this.size=e,this.v=i,this.reset()}rt.prototype.reset=function(){this.panel={back:null,btn:[]},this.lastPos=this.v?this.control.top:this.control.left},rt.prototype.addButton=function(t){var e;e=this.v?new nt(this.control.left,this.lastPos,this.control.width,this.size):new nt(this.lastPos,this.control.top,this.size,this.control.height),t.control=e,this.lastPos+=this.size,this.panel.btn[this.panel.btn.length]=t},rt.prototype.draw=function(){this.panel.btn.forEach((t=>{t.draw()}))},rt.prototype.isClicked=function(){this.panel.btn.forEach((t=>{t.isClicked()}))};const st=rt,at={pointInRectangle:(t,e)=>t.x>e.x0&&t.x<e.x1&&t.y>e.y0&&t.y<e.y1};function lt(t,e,i,o,n=!0){this.parent=t,this.control=e,this.backColor=i,o&&(this.click=o),this.enabled=n}lt.prototype.draw=function(){this.drawBackGround(),this.drawEnabled()},lt.prototype.drawBackGround=function(){e.context.fillStyle=this.backColor,e.context.fillRect(this.control.left,this.control.top,this.control.width,this.control.height)},lt.prototype.drawEnabled=function(){this.enabled||(e.context.fillStyle="#000",e.context.globalAlpha=.5,e.context.fillRect(this.control.left,this.control.top,this.control.width,this.control.height),e.context.globalAlpha=1)},lt.prototype.isClicked=function(){this.enabled&&at.pointInRectangle(n.mouse,this.control.getRect())&&this.click()},lt.prototype.click=function(){};const ht=lt;function ct(t,e,i,o,n,r,s,a=!0){ht.call(this,t,e,i,s,a),this.section=o,this.text=n,this.textColor=r}ct.prototype=Object.create(ht.prototype),ct.prototype.getText=function(){return s.getText(this.section,this.text)},ct.prototype.drawText=function(){e.context.fillStyle=this.textColor,e.context.font=e.buttonFont;var t=this.getText(),i=e.fontHeight(),o=~~((this.control.width-e.context.measureText(t).width)/2),n=~~((this.control.height-i)/2)+i;e.context.fillText(t,this.control.left+o,this.control.top+n)},ct.prototype.draw=function(){ht.prototype.drawBackGround.call(this),this.drawText(),ht.prototype.drawEnabled.call(this)};const ut=ct,pt={};pt.control=new nt(e.mainScreenWidth,e.topMenuHeight,e.rightMenuSize()),pt.panel=new st(pt.control,e.verticalButtonSize,!0),pt.backCtrl=new nt(e.mainScreenWidth,e.bottomOfMap()-e.verticalButtonSize,e.rightMenuSize(),e.verticalButtonSize),pt.back=new ut(null,pt.backCtrl,"#008","general","back",e.highlightColor,(function(){this.parent.unSelect()})),pt.draw=(t,i=null)=>{let o=e.context,n=e.topMenuHeight;o.fillStyle=e.backgroundColor,o.fillRect(e.mainScreenWidth,n,e.rightMenuSize(),e.bottomOfMap()-n),pt.panel.draw(),pt.back.draw()},pt.click=()=>{n.mouse.rightMenuClicked&&(pt.panel.isClicked(),pt.back.isClicked())},pt.configure=t=>{pt.panel.reset(),pt.back.parent=t,Object.keys(t.options).forEach((i=>{let o=t.options[i];o.isValid(t)&&pt.panel.addButton(new ut(t,null,"#008","general",o.text,e.highlightColor,o.click,o.isEnabled()))}))};const dt=pt,ft=function(t){let i=e.context;i.fillStyle=e.backgroundColor,i.fillRect(0,e.bottomOfMap(),e.mainScreenWidth,e.height-e.bottomOfMap())};var gt=(t,e)=>{var i,o=[];do{o.push(e),i=t.filter((t=>e.equals(t.pos))),e=!!i.length&&i[0].from.pos}while(e);return o},yt=(t,e)=>{for(let i=0;i<e.length;i++)if(t.equals(e[i]))return e[i];return!1},mt=(t,e)=>{for(let i=0;i<e.length;i++)if(t.equals(e[i].pos))return i;return-1},wt=(t,e)=>{var i=null,o=Number.MAX_VALUE;return e.forEach(((e,n)=>{e.score<o&&yt(e.pos,t)&&(i=e,o=e.score)})),i};const xt={find:function(t){return function(t,e,i){var o,n,r,s,a,l=[t],h=[],c=[],u=[],p=[];for(c.push({pos:t,score:t.movementCost()}),p.push({pos:t,score:i(t,e)});l.length>0;){if((a=wt(l,p)).pos.equals(e))return gt(h,a.pos);l=l.filter((t=>!t.equals(a.pos))),u.push(a.pos),a.pos.neighbors().forEach((t=>{yt(t,u)||(r=c.filter((t=>!a.pos.equals(t))),s=r[0].score+(a.pos,t.movementCost()),(-1==(n=mt(t,c))||c[n].score>s)&&((o=h.filter((t=>a.pos.equals(t.from)))).length?o[0].pos=t:h.push({pos:t,from:a}),-1==n?(c.push({pos:t,score:s}),p.push({pos:t,score:s+i(t,e)})):(c[n].score=s,p[n].score=s+i(t,e)),yt(t,l)||l.push(t)))}))}return!1}(t.pos,t.goal,St)}};var St=(t,e)=>t.distance(e);const vt=xt;function bt(t){Z.call(this),this.city=t,this.state="WAIT",this.goal=null,this.worldMap=t.parent.parent,this.pos=new p(t.parent.pos.x,t.parent.pos.y,this.worldMap),this.route=null,this.remainingMoves=this.moveRange,this.remainingTurnsToBuild=this.turnsToBuild,t.parent.unit=this}bt.prototype=Object.create(Z.prototype),bt.prototype.type=null,bt.prototype.moveRange=1,bt.prototype.turnsToBuild=5,bt.prototype.options={FORTIFY:{text:"fortify",click:function(){this.parent.state="FORTIFY",this.parent.unSelect()},isValid:t=>!0,isEnabled:t=>!0}},bt.prototype.cost={MINERAL:50},bt.prototype.refresh=function(){this.remainingMoves=this.moveRange},bt.prototype.text=function(){return s.getText("units",this.type)},bt.prototype.texture=function(){return F.textures.userResources[this.type]},bt.prototype.isWaiting=function(){return"MOVE"==this.state&&this.move(),"WAIT"==this.state&&this.remainingMoves>0},bt.prototype.goTo=function(t){this.goal=new p(t.x,t.y,this.worldMap),this.route=vt.find(this).reverse(),null==this.route||this.route.length<2||(this.state="MOVE",this.move())},bt.prototype.move=function(){this.worldMap.map[this.pos.x][this.pos.y].unit=null;let t=this.remainingMoves<this.route.length?this.remainingMoves:this.route.length;this.route=this.route.slice(t),this.pos=this.route[0],this.remainingMoves-=t,this.worldMap.map[this.pos.x][this.pos.y].unit=this,this.pos.equals(this.goal)&&(this.state="WAIT")},bt.prototype.getTile=function(){return this.worldMap.map[this.pos.x][this.pos.y]},bt.prototype.select=function(){this.worldMap.centerView(this.pos.x,this.pos.y),dt.configure(this)},bt.prototype.draw=function(){this.worldMap.drawBackground(),this.worldMap.drawUnits(this),dt.draw(this)},bt.prototype.drawUnit=function(){let t=(this.pos.x-this.worldMap.topLeftX+this.worldMap.options.width)%this.worldMap.options.width,i=(this.pos.y-this.worldMap.topLeftY+this.worldMap.options.height)%this.worldMap.options.height;t<e.horizontalTilesToShow()&&i<e.verticalTilesToShow()&&e.context.drawImage(this.texture(),t*e.tileSize,i*e.tileSize+e.topMenuHeight,e.tileSize,e.tileSize)},bt.prototype.drawSelectedUnit=function(){let t=e.context,i=t.globalAlpha;t.globalAlpha=Math.lerp(.5,1,l.gradient),this.drawUnit(),t.globalAlpha=i},bt.prototype.update=function(t){n.mouse.mainWindowClicked&&(this.goTo(this.worldMap.getTile(n.mouse.x,n.mouse.y-e.topMenuHeight)),this.unSelect()),dt.click(this)},bt.prototype.unSelect=function(){this.nextState=this.worldMap};const Tt=bt;function Mt(t){Tt.call(this,t),this.life=this.maxLife}Mt.prototype=Object.create(Tt.prototype),Mt.prototype.type="robots",Mt.prototype.maxLife=100;const kt=Mt;function Ct(t){kt.call(this,t)}Ct.prototype=Object.create(kt.prototype),Ct.prototype.type="construction",Ct.prototype.options.MINE={text:"mine",click:function(){it.buildMine(this.parent),this.parent.unSelect()},isValid:t=>{var e=t.getTile();return e.resource==m.resources.MINERAL&&!e.building},isEnabled:t=>U.checkAvailable(tt.prototype.getCost())};const zt=Ct,Rt={constructionRobot:t=>new zt(t)};function Ot(t){Z.call(this),this.parent=t,this.context=e.context,this.queue=[]}Ot.prototype=Object.create(Z.prototype),Ot.prototype.options={ROBOT:{text:"construction",click:function(){this.parent.addToConstructionQueue(Rt.constructionRobot(this.parent))},isValid:t=>!0,isEnabled:t=>!0}},Ot.prototype.text=function(){return"city"},Ot.prototype.getResources=function(){return Object.assign(U.getResourcesObject(),{MINERAL:5})},Ot.prototype.select=function(){this.parent.centerView(),dt.configure(this)},Ot.prototype.unSelect=function(){this.nextState=this.parent.parent},Ot.prototype.processTurn=function(){U.addResources(this.getResources()),this.queue.length&&(this.queue[0].remainingTurnsToBuild--,this.queue[0].remainingTurnsToBuild<=0&&D.addRobot(this.queue.shift()))},Ot.prototype.addToConstructionQueue=function(t){U.checkAvailable(t.cost)&&(U.removeResources(t.cost),this.queue.push(t),this.unSelect())},Ot.prototype.removeFromConstructionQueue=function(){let t=this.parent.queue.pop();U.addResources(t.cost)},Ot.prototype.update=function(){n.mouse.mainWindowClicked&&this.unSelect(),dt.click(this)},Ot.prototype.draw=function(){this.drawBackground(),dt.draw(),ft(this)},Ot.prototype.drawBackground=function(){this.parent.parent.draw(),this.context.globalAlpha=.5,this.context.fillStyle="#008",this.context.fillRect(0,e.topMenuHeight,e.mainScreenWidth,e.mainScreenHeight),this.context.globalAlpha=1};const At=Ot,Et={cities:[],addCity:(t,i,o)=>{t.mapCanvas.getContext("2d").drawImage(F.textures.general.city,i*e.maxTileSize(),o*e.maxTileSize(),e.maxTileSize(),e.maxTileSize());var n=new At(t.map[i][o]);return t.map[i][o].building=n,Et.cities.push(n),n},reset:()=>{Et.cities=[]}},Lt=Et,Wt={turn:0,screen:null,advance:function(){var t=D.unitsWaiting();t.length?t[0].worldMap.nextState=t[0]:(Lt.cities.forEach((t=>t.processTurn())),it.buildings.forEach((t=>U.addResources(t.getResources()))),it.queue.forEach((t=>{if("BUILD"==t.tile.unit.state&&t.tile.unit.remainingMoves>0){t.tile.unit.remainingMoves=0,t.turnsBuilt++;var i=t.worldMap.resourcesCanvas.getContext("2d");i.globalAlpha=t.turnsBuilt/t.turnsToBuild,i.clearRect(t.pos.x*e.maxTileSize(),t.pos.y*e.maxTileSize(),e.maxTileSize(),e.maxTileSize()),i.drawImage(t.texture(),t.pos.x*e.maxTileSize(),t.pos.y*e.maxTileSize(),e.maxTileSize(),e.maxTileSize()),i.globalAlpha=1,t.turnsBuilt==t.turnsToBuild&&(it.buildings.push(t),t.tile.unit.state="WAIT")}})),it.queue=it.queue.filter((t=>t.turnsBuilt!=t.turnsToBuild)),Wt.turn++,D.list.robot.forEach((t=>t.refresh())))},init:function(){Wt.turn=0},reset:function(t){Wt.turn=0,Wt.screen=t}},Bt=Wt;function Ft(){}Ft.prototype.noise=function(t,e,i){var o=255&Math.floor(t),n=255&Math.floor(e),r=255&Math.floor(i);t-=Math.floor(t),e-=Math.floor(e),i-=Math.floor(i);var s=this.fade(t),a=this.fade(e),l=this.fade(i),h=this.p[o]+n,c=this.p[h]+r,u=this.p[h+1]+r,p=this.p[o+1]+n,d=this.p[p]+r,f=this.p[p+1]+r;return Math.lerp(Math.lerp(Math.lerp(this.grad(this.p[c],t,e,i),this.grad(this.p[d],t-1,e,i),s),Math.lerp(this.grad(this.p[u],t,e-1,i),this.grad(this.p[f],t-1,e-1,i),s),a),Math.lerp(Math.lerp(this.grad(this.p[c+1],t,e,i-1),this.grad(this.p[d+1],t-1,e,i-1),s),Math.lerp(this.grad(this.p[u+1],t,e-1,i-1),this.grad(this.p[f+1],t-1,e-1,i-1),s),a),l)},Ft.prototype.fade=function(t){return t*t*t*(t*(6*t-15)+10)},Ft.prototype.grad=function(t,e,i,o){var n=15&t,r=n<8?e:i,s=n<4?i:12==n||14==n?e:o;return(0==(1&n)?r:-r)+(0==(2&n)?s:-s)},Ft.prototype.p=[151,160,137,91,90,15,131,13,201,95,96,53,194,233,7,225,140,36,103,30,69,142,8,99,37,240,21,10,23,190,6,148,247,120,234,75,0,26,197,62,94,252,219,203,117,35,11,32,57,177,33,88,237,149,56,87,174,20,125,136,171,168,68,175,74,165,71,134,139,48,27,166,77,146,158,231,83,111,229,122,60,211,133,230,220,105,92,41,55,46,245,40,244,102,143,54,65,25,63,161,1,216,80,73,209,76,132,187,208,89,18,169,200,196,135,130,116,188,159,86,164,100,109,198,173,186,3,64,52,217,226,250,124,123,5,202,38,147,118,126,255,82,85,212,207,206,59,227,47,16,58,17,182,189,28,42,223,183,170,213,119,248,152,2,44,154,163,70,221,153,101,155,167,43,172,9,129,22,39,253,19,98,108,110,79,113,224,232,178,185,112,104,218,246,97,228,251,34,242,193,238,210,144,12,191,179,162,241,81,51,145,235,249,14,239,107,49,192,214,31,181,199,106,157,184,84,204,176,115,121,50,45,127,4,150,254,138,236,205,93,222,114,67,29,24,72,243,141,128,195,78,66,215,61,156,180,151,160,137,91,90,15,131,13,201,95,96,53,194,233,7,225,140,36,103,30,69,142,8,99,37,240,21,10,23,190,6,148,247,120,234,75,0,26,197,62,94,252,219,203,117,35,11,32,57,177,33,88,237,149,56,87,174,20,125,136,171,168,68,175,74,165,71,134,139,48,27,166,77,146,158,231,83,111,229,122,60,211,133,230,220,105,92,41,55,46,245,40,244,102,143,54,65,25,63,161,1,216,80,73,209,76,132,187,208,89,18,169,200,196,135,130,116,188,159,86,164,100,109,198,173,186,3,64,52,217,226,250,124,123,5,202,38,147,118,126,255,82,85,212,207,206,59,227,47,16,58,17,182,189,28,42,223,183,170,213,119,248,152,2,44,154,163,70,221,153,101,155,167,43,172,9,129,22,39,253,19,98,108,110,79,113,224,232,178,185,112,104,218,246,97,228,251,34,242,193,238,210,144,12,191,179,162,241,81,51,145,235,249,14,239,107,49,192,214,31,181,199,106,157,184,84,204,176,115,121,50,45,127,4,150,254,138,236,205,93,222,114,67,29,24,72,243,141,128,195,78,66,215,61,156,180];const Ht=Ft,It={generate:function(t){It.generateWorld(t),It.generateStartingPoint(t),m.generateResources(t)},generateWorld:function(t){var i=document.createElement("canvas");i.width=t.options.width*e.maxTileSize(),i.height=t.options.height*e.maxTileSize();for(var o,n,r,s,a,l,h,c,u,p=i.getContext("2d"),d=new Ht,g=.04+.05*Math.random(),y=.075+.05*Math.random(),m=2*Math.PI/t.options.width,w=t.options.width/8,x=0,S=new Array(t.options.width),v=0;v<t.options.width;v++){S[v]=new Array(t.options.height),c=w*Math.sin(x),u=w*Math.cos(x),o=g*c+t.options.heightSeedX,n=g*u+t.options.heightSeedZ,r=y*c+t.options.humiditySeedX,s=y*u+t.options.humiditySeedZ;for(var b=0;b<t.options.height;b++)a=d.noise(o,b*g+t.options.heightSeedY,n),l=d.noise(r,b*y+t.options.humiditySeedY,s),h=new f(t,a,l,v,b),S[v][b]=h,p.drawImage(F.textures.mapTile[h.type],v*e.maxTileSize(),b*e.maxTileSize(),e.maxTileSize(),e.maxTileSize()),t.stats[h.type]+=1;x+=m}t.map=S,t.mapCanvas=i;var T=document.createElement("canvas");T.width=i.width,T.height=i.height,t.resourcesCanvas=T},generateStartingPoint:function(t){var e,i;do{e=~~(Math.random()*t.options.width),i=15+~~(Math.random()*(t.options.height-30))}while("grass"!=t.map[e][i].type);let o=Lt.addCity(t,e,i);D.addRobot(Rt.constructionRobot(o)),t.startingPointX=e,t.startingPointY=i,t.centerViewonStartingPoint()},generateOptions:function(t){var e=24+~~(15*Math.random()),i={};return i.width=4*e,i.height=3*e,"normal"==t.type&&(i.waterHeight=.35+.2*Math.random(),i.heightSeedX=Math.random(),i.heightSeedY=Math.random(),i.heightSeedZ=Math.random(),i.humiditySeedX=Math.random(),i.humiditySeedY=Math.random(),i.humiditySeedZ=Math.random()),i}},Vt=It,Pt={normalMapView:function(t){var i=e.context,o=e.horizontalTilesToShow(),n=e.verticalTilesToShow(),r=t.topLeftX*e.maxTileSize(),s=t.topLeftY*e.maxTileSize(),a=o*e.maxTileSize(),l=n*e.maxTileSize(),h=0,c=e.topMenuHeight,u=e.mainScreenWidth,p=e.mainScreenHeight,d=t.options.width-t.topLeftX;i.drawImage(t.mapCanvas,r,s,a,l,h,c,u,p),i.drawImage(t.resourcesCanvas,r,s,a,l,h,c,u,p),d<o&&(r=0,h=d*e.tileSize,i.drawImage(t.mapCanvas,r,s,a,l,h,c,u,p),i.drawImage(t.resourcesCanvas,r,s,a,l,h,c,u,p))},heightMapView:function(t){var i,o,n,r,s,a=e.context,l=e.horizontalTilesToShow(),h=e.verticalTilesToShow();for(i=0;i<l;i++)for(r=i*e.tileSize,o=0;o<h;o++)s=o*e.tileSize+e.topMenuHeight,n=t.map[(t.topLeftX+i)%t.options.width][(t.topLeftY+o)%t.options.height],a.fillStyle=n.heightGray(),a.fillRect(r,s,e.tileSize,e.tileSize)},humidityMapView:function(t){var i,o,n,r,s,a=e.context,l=e.horizontalTilesToShow(),h=e.verticalTilesToShow();for(i=0;i<l;i++)for(r=i*e.tileSize,o=0;o<h;o++)s=o*e.tileSize+e.topMenuHeight,n=t.map[(t.topLeftX+i)%t.options.width][(t.topLeftY+o)%t.options.height],a.fillStyle=n.humidityGray(),a.fillRect(r,s,e.tileSize,e.tileSize)},blockMapView:function(t){var i,o,n,r,s,a=e.context,l=e.horizontalTilesToShow(),h=e.verticalTilesToShow();for(i=0;i<l;i++)for(r=i*e.tileSize,o=0;o<h;o++)s=o*e.tileSize+e.topMenuHeight,n=t.map[(t.topLeftX+i)%t.options.width][(t.topLeftY+o)%t.options.height],a.fillStyle=n.mapColor(),a.fillRect(r,s,e.tileSize,e.tileSize)}};Pt.drawArray=[Pt.normalMapView,Pt.heightMapView,Pt.humidityMapView,Pt.blockMapView];const Yt=Pt;function jt(t,e,i,o,n){!function(t,e,i,o){t.drawImage(F.textures[i][o],e.left,e.top,e.width,e.height),e.left+=e.width}(e,i,o,n),qt(U.resources[n],e,i),i.advanceHor()}function qt(t,e,i){e.fillText(t,i.left,i.top+12)}const _t=function(t){var i=new nt(5,5,15,15),o=e.context;for(var n in o.fillStyle=e.textColor,o.font=e.normalFont,jt(0,o,i,"userResources","construction"),m.resources)jt(0,o,i,"naturalResources",n);i.left=e.mainScreenWidth,qt("T "+Bt.turn,o,i)},Xt=function(t){if(t){var i=e.context;i.fillStyle=e.textColor,i.font=e.normalFont;var o,n,r=e.fontHeight();o=e.bottomOfMap()+e.topMenuHeight,n=t.type,i.fillText(n,15,o),o+=r,n="Height: "+t.height,i.fillText(n,15,o),o+=r,n="Humidity: "+t.humiditySeed,i.fillText(n,15,o),t.resource&&(o+=r,n=s.getText("resources",t.resource.text),i.fillText(n,15,o))}},Gt={init:()=>{var t=e.bottomOfMap()-e.verticalButtonSize,i=new nt(e.mainScreenWidth,t,e.rightMenuSize(),e.verticalButtonSize);Gt.nextTurnBtn=new ut(Gt,i,"#008","general","nextTurn",e.highlightColor,(()=>{Bt.advance()}))},draw:t=>{let i=e.context,o=e.topMenuHeight;i.fillStyle=e.backgroundColor,i.fillRect(e.mainScreenWidth,o,e.rightMenuSize(),e.bottomOfMap()-o),o=e.topMenuHeight,Gt.nextTurnBtn.draw()},mouseClick:()=>{Gt.nextTurnBtn.isClicked()}},Ut=Gt,Nt={draw:function(t){var i=e.context;i.drawImage(t.mapCanvas,e.mainScreenWidth,e.bottomOfMap(),e.width-e.mainScreenWidth,e.height-e.bottomOfMap());var o=e.rightMenuSize()/t.options.width,n=e.lowerMenuSize()/t.options.height,r=e.mainScreenWidth+t.topLeftX*o,s=e.bottomOfMap()+t.topLeftY*n,a=e.horizontalTilesToShow()*o,h=e.verticalTilesToShow()*n,c=Math.lerp(.7,1,l.gradient);i.strokeStyle="rgba(0,0,0,"+c+")",i.strokeRect(r,s,a,h);var u=r+a-e.width;u>0&&i.strokeRect(e.mainScreenWidth,s,u,h)},mouseClick:function(t,i,o){t.centerView(~~(i/e.rightMenuSize()*t.options.width),~~(o/e.lowerMenuSize()*t.options.height))}};function Dt(t,e){Z.call(this),this.sx=0}Dt.prototype=Object.create(Z.prototype),Dt.prototype.update=function(){},Dt.prototype.draw=function(){e.context.drawImage(F.textures.research.tree,this.sx,0,e.mainScreenWidth,e.mainScreenHeight,0,e.topMenuHeight,e.mainScreenWidth,e.mainScreenHeight)};const Kt=Dt;function Zt(t,e){for(var i in Z.call(this),this.options=t,this.parent=e,this.stats=[],f.prototype.tileTypes)this.stats[i]=0;Vt.generate(this),this.tileClicked=null,this.superiorSideTile=null,this.typeOfView=0,Ut.init()}Zt.prototype=Object.create(Z.prototype),Zt.prototype.draw=function(){var t=e.context;t.fillStyle=e.backgroundColor,t.fillRect(0,0,e.width,e.height),this.drawBackground(),this.drawUnits(),Xt(this.getTileClicked()),_t(this),Ut.draw(this),Nt.draw(this)},Zt.prototype.drawBackground=function(){Yt.drawArray[this.typeOfView](this)},Zt.prototype.drawUnits=function(t=null){D.list.robot.forEach((e=>{t==e?e.drawSelectedUnit():e.drawUnit()}))},Zt.prototype.update=function(t){n.keyboard.ARROW_LEFT.execute()&&this.moveLeft(),n.keyboard.ARROW_RIGHT.execute()&&this.moveRight(),n.keyboard.ARROW_UP.execute()&&this.moveUp(),n.keyboard.ARROW_DOWN.execute()&&this.moveDown(),n.keyboard.V.execute()&&this.changeView(),n.keyboard.C.execute()&&this.centerViewonStartingPoint(),n.keyboard.T.execute()&&(this.nextState=new Kt),n.keyboard.SPACE.execute()&&Bt.advance(),n.mouse.mainWindowClicked&&this.mouseClick(n.mouse.x,n.mouse.y-e.topMenuHeight),n.mouse.miniMapClicked&&Nt.mouseClick(this,n.mouse.x-e.mainScreenWidth,n.mouse.y-e.bottomOfMap()),n.mouse.rightMenuClicked&&Ut.mouseClick()},Zt.prototype.getTile=function(t,i){return{x:(~~(t/e.tileSize)+this.topLeftX)%this.options.width,y:(~~(i/e.tileSize)+this.topLeftY)%this.options.height}},Zt.prototype.mouseClick=function(t,i){this.tileClicked=this.getTile(t,i),this.superiorSideTile=(i-(this.tileClicked.y-this.topLeftY)*e.tileSize)/e.tileSize<.5,this.nextState=this.getTileClicked().getState()},Zt.prototype.moveLeft=function(){this.topLeftX=(this.options.width+this.topLeftX-1)%this.options.width},Zt.prototype.moveRight=function(){this.topLeftX=(this.topLeftX+1)%this.options.width},Zt.prototype.moveUp=function(){this.topLeftY>0&&(this.topLeftY=this.topLeftY-1)},Zt.prototype.moveDown=function(){this.topLeftY+e.verticalTilesToShow()<this.options.height&&(this.topLeftY=this.topLeftY+1)},Zt.prototype.changeView=function(){this.typeOfView=(this.typeOfView+1)%Yt.drawArray.length},Zt.prototype.getTileClicked=function(){return this.tileClicked?this.map[this.tileClicked.x][this.tileClicked.y]:null},Zt.prototype.centerView=function(t,i){this.topLeftX=(~~(t-e.horizontalTilesToShow()/2)+this.options.width)%this.options.width,this.topLeftY=~~(i-e.verticalTilesToShow()/2),this.topLeftY<0?this.topLeftY=0:this.topLeftY+e.verticalTilesToShow()>this.options.height&&(this.topLeftY=this.options.height-e.verticalTilesToShow())},Zt.prototype.centerViewonStartingPoint=function(){this.centerView(this.startingPointX,this.startingPointY)};const Qt=Zt;function Jt(){Bt.reset(this),U.init(),D.reset(),it.reset(),x.reset(),this.totalTime=0,this.worldMap=new Qt(Vt.generateOptions({type:"normal"}),this),this.currentState=this.worldMap}Jt.prototype.update=function(t){if(this.totalTime+=t,n.keyboard.O.execute())return H.addScreen(new X),void n.resetKeyboard();n.keyboard.ESC.execute()&&(this.currentState==this.worldMap?H.removeScreen():this.currentState.nextState=this.worldMap,n.resetKeyboard()),this.currentState.changeState(this),this.currentState.update(t)},Jt.prototype.draw=function(){this.currentState.draw()};const $t=Jt;function te(){V.call(this),this.section="mainMenu",this.addButton("start",(function(){H.addScreen(new $t)})),this.addButton("options",(function(){H.addScreen(new X)}))}te.prototype=Object.create(V.prototype);const ee=te;var ie=0;function oe(t){var i=t-ie;ie=t,l.updateGradient(t),H.draw(),H.update(i),n.mouse.reset(),!e.hasToExit&&H.screenExists()?window.requestAnimationFrame(oe):console.log("Game over")}window.onload=function(){e.hasToExit=!1,l.readUserLanguage(),F.load();var t=document.getElementById("main_canvas");e.context=t.getContext("2d"),n.init(),document.onkeydown=function(t){n.keyDown(t.keyCode)},t.addEventListener("click",(function(e){n.mouseClick(e.pageX-t.offsetLeft,e.pageY-t.offsetTop)}),!1),H.addScreen(new ee),window.requestAnimationFrame(oe)}})();