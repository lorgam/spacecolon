(()=>{"use strict";const t={context:null,hasToExit:!1,width:1024,height:793,mainScreenWidth:896,mainScreenHeight:672,topMenuHeight:25,tileSize:16,menuFont:"30px Arial",buttonFont:"22px Arial",normalFont:"14px Arial",backgroundColor:"#000",textColor:"#FFF",highlightColor:"#F00",verticalButtonSize:44,minTileSize:function(){return 8},mediumTileSize:function(){return 16},maxTileSize:function(){return 32},horizontalTilesToShow:function(){return~~(t.mainScreenWidth/t.tileSize)},verticalTilesToShow:function(){return~~(t.mainScreenHeight/t.tileSize)},bottomOfMap:function(){return t.topMenuHeight+t.mainScreenHeight},rightMenuSize:function(){return t.width-t.mainScreenWidth},lowerMenuSize:function(){return t.height-t.bottomOfMap()},fontHeight:function(){return parseInt(t.context.font.match(/\d+/))}},e=t,i={keyboard:{aux:{}},mouse:{x:0,y:0,movedx:0,movedy:0,isDown:!1,isDragged:!1,isClicked:!1,mainWindowClicked:!1,rightMenuClicked:!1,lowerMenuClicked:!1,miniMapClicked:!1,reset:function(){i.mouse.isClicked=!1,i.mouse.mainWindowClicked=!1,i.mouse.rightMenuClicked=!1,i.mouse.lowerMenuClicked=!1,i.mouse.miniMapClicked=!1}},init:function(){i.keyboard.ARROW_LEFT=new o(37),i.keyboard.ARROW_UP=new o(38),i.keyboard.ARROW_RIGHT=new o(39),i.keyboard.ARROW_DOWN=new o(40),i.keyboard.ENTER=new o(13),i.keyboard.ALT=new o(18),i.keyboard.ESC=new o(27),i.keyboard.SPACE=new o(32),i.keyboard.O=new o(79),i.keyboard.C=new o(67),i.keyboard.V=new o(86),i.keyboard.T=new o(84)},keyDown:function(t){var e=i.keyboard.aux[t];e&&e.keyDown()},mouseMove:function(t,e){i.mouse.isPressed&&(i.mouse.isDragged=!0,i.mouse.movedx=t,i.mouse.movedy=e)},mouseDown:function(t,e){i.mouse.isPressed=!0,i.mouse.x=t,i.mouse.y=e},mouseUp:function(t,e){i.mouse.isPressed=!1,i.mouse.isDragged?i.mouse.isDragged=!1:i.mouseClick(t,e)},mouseClick:function(t,o){i.mouse.x=t,i.mouse.y=o,i.mouse.isClicked=!0,i.mouse.x<e.mainScreenWidth?i.mouse.y>e.bottomOfMap()?i.mouse.lowerMenuClicked=!0:i.mouse.y>e.topMenuHeight&&(i.mouse.mainWindowClicked=!0):i.mouse.y>=e.bottomOfMap()?i.mouse.miniMapClicked=!0:i.mouse.rightMenuClicked=!0},resetKeyboard:function(){Object.keys(i.keyboard).forEach(((t,e)=>{i.keyboard[t].execute&&i.keyboard[t].execute()}))}};function o(t){this.isPressed=!1,this.keyCode=t,i.keyboard.aux[t]=this}o.prototype.keyDown=function(){this.isPressed=!0},o.prototype.execute=function(){return!!this.isPressed&&(this.isPressed=!1,!0)};const n=i,r={language:"en",en:{mainMenu:{start:"Start",options:"Options",exit:"Exit"},optionsMenu:{language:"Language",tileSize:"Tile Size",little:"Little",medium:"Medium",big:"Big"},resources:{mineral:"mineral",gas:"gas",fish:"fish",hervibore:"hervibore"},general:{back:"Back",nextTurn:"Next turn",move:"Move",fortify:"Fortify",mine:"Mine",cancel:"Cancel",robots:"Robot",construction:"Construction robot"}},es:{mainMenu:{start:"Empezar",options:"Opciones",exit:"Salir"},optionsMenu:{language:"Idioma",tileSize:"Tamaño de cuadricula",little:"Pequeño",medium:"Mediano",big:"Grande"},resources:{mineral:"mineral",gas:"gas",fish:"peces",hervibore:"hervíboros"},general:{back:"volver",nextTurn:"Siguiente turno",move:"Mover",fortify:"Fortificar",mine:"Mina",cancel:"Cancelar",robots:"Robot",construction:"Robot de construccion"}},getText:function(t,e){return r[r.language][t][e]}},s=r,a={gradient:0,getGrey:function(t){return Math.lerp(0,255,t)},updateGradient:function(t){a.gradient=.5*Math.sin(.003*t)+.5},readUserLanguage:function(){if(navigator&&navigator.languages)for(var t in navigator.languages)for(var e in s)if(e==navigator.languages[t])return void(s.language=e)}};Math.lerp=function(t,e,i){return t+i*(e-t)},Math.tileDistance=function(t,e,i,o){return Math.abs(t-i)+Math.abs(e-o)};const l=a;function h(t,e){this.x=t,this.y=e}h.prototype.equals=function(t){return this.x==t.x&&this.y==t.y},h.prototype.distance=function(t){return Math.abs(this.x-t.x)+Math.abs(this.y-t.y)},h.prototype.neighbors=function(){return[new h(this.x+1,this.y),new h(this.x-1,this.y),new h(this.x,this.y+1),new h(this.x,this.y-1)]};const p=h;function c(t,e,i){p.call(this,t,e),this.worldMap=i}c.prototype=Object.create(p.prototype),c.prototype.neighbors=function(){let t=[];var e=this.worldMap.options;return t.push(new c((this.x+1+e.width)%e.width,this.y,this.worldMap)),t.push(new c((this.x-1+e.width)%e.width,this.y,this.worldMap)),this.y>0&&t.push(new c(this.x,this.y-1,this.worldMap)),this.y<e.height-1&&t.push(new c(this.x,this.y+1,this.worldMap)),t},c.prototype.movementCost=function(){return this.worldMap.map[this.x][this.y].movementCost()},c.prototype.distance=function(t){let e=Math.abs(t.x-this.x),i=this.worldMap.options.width-e;return e=e>i?i:e,e+Math.abs(t.y-this.y)};const u=c;function d(t,e,i,o,n){this.parent=t,this.heightSeed=e,this.humiditySeed=i,this.height=.5*this.heightSeed+.5,this.type=this.tileType(this.parent.options.waterHeight),this.water=this.height<this.parent.options.waterHeight,this.resource=null,this.building=null,this.unit=null,this.pos=new u(o,n,t)}d.prototype.tileTypes={deepOcean:{color:"#072253"},ocean:{color:"#12326E"},shallowWaters:{color:"#1F4487"},beach:{color:"#FFCF75"},highMountain:{color:"#7A0009"},desert:{color:"#E2AB46"},grass:{color:"#71D361"},forest:{color:"#1B880A"},desertMountain:{color:"#7D5100"},grassMountain:{color:"#4BBB3A"},forestMountain:{color:"#0E6700"}},d.prototype.tileType=function(t){if(this.height<t-.25)return"deepOcean";if(this.height<t-.05)return"ocean";if(this.height<t)return"shallowWaters";if(this.height<t+.013)return"beach";if(this.height>.85)return"highMountain";var e=.8-t;return this.height<.6*e+t?this.humiditySeed<-.4?"desert":this.humiditySeed<.5?"grass":"forest":this.humiditySeed<-.4?"desertMountain":this.humiditySeed<.5?"grassMountain":"forestMountain"},d.prototype.mapColor=function(){return this.tileTypes[this.type].color},d.prototype.heightGray=function(){var t=l.getGrey(this.height);return"rgb("+t+","+t+","+t+")"},d.prototype.humidityGray=function(){var t=l.getGrey(.5*this.humiditySeed+.5);return"rgb("+t+","+t+","+t+")"},d.prototype.texture=function(){return W.textures.mapTile[this.type]},d.prototype.movementCost=function(){return this.water?10:1},d.prototype.getState=function(){return null!==this.unit&&null!==this.building?this.parent.superiorSideTile?this.unit:this.building:null!==this.unit?this.unit:null!==this.building?this.building:null},d.prototype.centerView=function(){this.parent.centerView(this.pos.x,this.pos.y)};const f=d,m={generateResource:function(t,i,o,n,r,s){var a,l,h,p=0,c=t.mapCanvas.getContext("2d");for(a=0;a<r.length;a++)p+=t.stats[r[a]];for(p=~~(p*s);p>0;)a=~~(Math.random()*t.options.width),l=~~(Math.random()*t.options.height),(h=t.map[a][l]).resource||-1==r.indexOf(h.type)||h.building||(p--,h.resource=i.resources[n],c.drawImage(W.textures[o][n],a*e.maxTileSize(),l*e.maxTileSize(),e.maxTileSize(),e.maxTileSize()))}},g=m,y={resources:{MINERAL:{color:"#DC444F",text:"mineral",default:100,proportion:.0075,terrain:["grass","grassMountain","forest"]},GAS:{color:"#CB8F1E",text:"gas",default:10,proportion:.005,terrain:["deepOcean","ocean"]},GRASSLIFE:{color:"#5774AA",text:"hervibore",default:25,proportion:.005,terrain:["grass","grassMountain","forest"]},SEALIFE:{color:"#FFF",text:"fish",default:50,proportion:.0075,terrain:["deepOcean","ocean"]}},generateResources:function(t){var e,i;for(e in y.resources)i=y.resources[e],g.generateResource(t,y,"naturalResources",e,i.terrain,i.proportion)}},v=y,x={iconSize:50,techPerLevel:[],maxWidth:0,reset:()=>{let t,e,i,o=[x.root],n=[];for(;o.length>0;){for(e in t=o.shift(),t.completion=0,t.children)i=t.children[e],n.includes(i)||o.push(i);n.push(t)}}},b=x,w={name:"initial_technology",cost:10,completed:()=>{console.log("first technology",void 0)},parents:[],icon:{type:"star",sides:4,color:"#F00"}},S={name:"final_technology",cost:100,completed:()=>{console.log("final technology",void 0)},parents:[{name:"pre_final_technology",cost:75,completed:()=>{console.log("preFinal technology",void 0)},parents:[{name:"ultima_technology",cost:75,completed:()=>{console.log("ultima technology",void 0)},parents:[{name:"dark_technology",cost:75,completed:()=>{console.log("preFinal technology",void 0)},parents:[{name:"nano_technology",cost:75,completed:()=>{console.log("nano technology",void 0)},parents:[{name:"adv_mineral_technology",cost:50,completed:()=>{console.log("advanced mineral technology",void 0)},parents:[{name:"mineral_technology",cost:20,completed:()=>{console.log("mineral technology",void 0)},parents:[w],icon:{type:"polygon",sides:3,color:"#F00"}}],icon:{type:"polygon",sides:6,color:"#FF0"}},{name:"robots_technology",cost:50,completed:()=>{console.log("robots technology",void 0)},parents:[w],icon:{type:"star",sides:5,color:"#FF0"}}],icon:{type:"star",sides:10,color:"#FF0"}}],icon:{type:"star",sides:10,color:"#999"}}],icon:{type:"star",sides:10,color:"#0FF"}}],icon:{type:"star",sides:11,color:"#0F0"}}],icon:{type:"star",sides:12,color:"#FFF"}};x.root=w,x.end=S;let k=x.end;k.children=[],k.level=0;let T,M,C,z=[k];for(;z.length>0;)for(M in T=z.shift(),T.parents)C=T.parents[M],C.children?(C.children.push(T),C.level<T.level+1&&(C.level=T.level+1)):(C.children=[T],C.level=T.level+1),z.includes(C)||z.push(C);x.techPerLevel=Array(x.root.level+1).fill(0),z=[x.root];let R,O=[];for(;z.length>0;)for(M in T=z.shift(),O.push(T),T.levelPos=x.techPerLevel[T.level]++,T.children)R=T.children[M],O.includes(R)||z.includes(R)||z.push(R);x.maxWidth=Math.max(...x.techPerLevel)+1;const D={textures:[],tileSize:100,load:function(){D.textures.mapTile=function(){let t,e,i=[];for(t in f.prototype.tileTypes)e=A(D.tileSize,D.tileSize),q(e,f.prototype.tileTypes[t].color),i[t]=e;return i}(),D.textures.userResources=function(){let t,e=[];return t=A(D.tileSize,D.tileSize),L(t,D.tileSize,6,"#FF0"),e.construction=t,e}(),D.textures.naturalResources=function(){let t,e,i=[];for(t in v.resources)e=A(D.tileSize,D.tileSize),E(e,D.tileSize,v.resources[t].color),i[t]=e;return i}(),D.textures.buildings=function(){let t,e=[];return t=A(D.tileSize,D.tileSize),function(t,e,i){var o=t.getContext("2d");o.fillStyle="#FFF",o.beginPath(),o.moveTo(0,e/2-10),o.lineTo(0,e/2+10),o.lineTo(e,e/2+10),o.lineTo(e,e/2-10),o.closePath(),o.fill(),o.beginPath(),o.moveTo(e/2-10,0),o.lineTo(e/2+10,0),o.lineTo(e/2+10,e),o.lineTo(e/2-10,e),o.closePath(),o.fill()}(t,D.tileSize),e.mine=t,e}(),D.textures.general=function(){let t,e=[];return t=A(D.tileSize,D.tileSize),j(t,D.tileSize,5,"#0FF"),e.city=t,e}(),D.textures.research=function(){const t=50,e=t+(b.root.level+1)*(b.iconSize+t),i=t+b.maxWidth*(b.iconSize+t);let o=[],n=A(i,e),r=A(i,e),s=A(i,e),a=n.getContext("2d"),l=r.getContext("2d"),h=s.getContext("2d");a.fillStyle="#CB8F1E",a.fillRect(0,0,i,e),h.fillStyle="#FFF";let p=[b.root],c=[];for(;p.length>0;){let e=p.shift();const n=b.techPerLevel[e.level],r=(i-(t+b.iconSize)*n)/2+e.levelPos*(t+b.iconSize),s=t+(b.root.level-e.level)*(t+b.iconSize);e.pos={x:r,y:s};let a=F(e.icon);o[e.name]=a,l.drawImage(a,r,s,b.iconSize,b.iconSize);for(let t in e.children){let i=e.children[t];c.includes(i)||p.includes(i)||p.push(i)}}for(p=[b.root],c=[];p.length>0;){let t=p.shift();t.parents.forEach((e=>{h.beginPath(),h.moveTo(e.pos.x+b.iconSize/2,e.pos.y+b.iconSize/2),h.lineTo(t.pos.x+b.iconSize/2,t.pos.y+b.iconSize/2),h.stroke()}));for(let e in t.children){let i=t.children[e];c.includes(i)||p.includes(i)||p.push(i)}}return a.drawImage(s,0,0,i,e),a.filter="brightness(0.75)",a.drawImage(r,0,0,i,e),a.filter=null,o.tree=n,o}()}};function A(t,e){var i=document.createElement("canvas");return i.width=t,i.height=e,i}function q(t,e){var i=t.getContext("2d");i.fillStyle=e,i.fillRect(0,0,t.width,t.height)}function E(t,e,i){var o=t.getContext("2d");o.fillStyle=i,o.beginPath(),o.moveTo(0,e/2),o.lineTo(e/2,e),o.lineTo(e,e/2),o.lineTo(e/2,0),o.closePath(),o.fill()}function L(t,e,i,o){const n=e/2,r=2*Math.PI/i;var s=t.getContext("2d");s.fillStyle=o,s.beginPath(),s.moveTo(2*n,n);for(let t=1;t<i;t++){const e=r*t;s.lineTo(n+Math.cos(e)*n,n+Math.sin(e)*n)}s.closePath(),s.fill()}function j(t,e,i,o){const n=e/2,r=e/4,s=2*Math.PI/i;var a=t.getContext("2d");a.fillStyle=o,a.beginPath(),a.moveTo(2*n,n);for(let t=0;t<i;t++){let e=s*t;a.lineTo(n+Math.cos(e)*n,n+Math.sin(e)*n),e+=s/2,a.lineTo(n+Math.cos(e)*r,n+Math.sin(e)*r)}a.closePath(),a.fill()}function F(t){const e=D.tileSize;let i=A(e,e),o=i.getContext("2d");switch(t.type){case"polygon":L(i,e,t.sides,t.color);break;case"star":j(i,e,t.sides,t.color);break;default:o.fillStyle="#FFF",o.fillRect(0,0,e,e)}return i}const W=D,H={stack:[],screenExists:function(){return this.stack.length>0},addScreen:function(t){n.keyboard.ENTER.execute(),this.stack.unshift(t)},removeScreen:function(){return n.keyboard.ENTER.execute(),this.stack.shift()},draw:function(){this.stack[0].draw()},update:function(t){this.stack[0].update(t)}};function I(){this.selectedOption=0,this.optionArray=[]}I.prototype.update=function(t){n.keyboard.ESC.execute()&&H.screenExists()&&H.removeScreen(),n.keyboard.ENTER.execute()&&this.optionArray[this.selectedOption].execute(),n.keyboard.ARROW_UP.execute()&&(this.selectedOption=(this.selectedOption+this.optionArray.length-1)%this.optionArray.length),n.keyboard.ARROW_DOWN.execute()&&(this.selectedOption=(this.selectedOption+1)%this.optionArray.length),n.keyboard.ARROW_RIGHT.execute()&&this.optionArray[this.selectedOption].nextOption(),n.keyboard.ARROW_LEFT.execute()&&this.optionArray[this.selectedOption].previousOption()},I.prototype.padding=2,I.prototype.draw=function(){var t=e.context;t.fillStyle=e.backgroundColor,t.fillRect(0,0,e.width,e.height),t.fillStyle=e.textColor,t.font=e.menuFont;var i,o,n=e.fontHeight(),r=(n+2*this.padding)*this.optionArray.length,s=(e.height-r)/2+this.padding+n;for(var a in this.optionArray){if(i=this.optionArray[a].getText(this.section),o=t.measureText(i).width,this.selectedOption==a){var h=Math.lerp(0,128,l.gradient);t.fillStyle="rgb(255,"+h+","+h+")",t.fillText(i,(e.width-o)/2,s),t.fillStyle=e.textColor}else t.fillText(i,(e.width-o)/2,s);s+=2*this.padding+n}},I.prototype.addButton=function(t,e){this.optionArray.push(new B(t,e))},I.prototype.addSelection=function(t,i,o){var n=e[o];for(var r in i)if(i[r].value==n)return void this.optionArray.push(new U(t,i,r,o))},I.prototype.addLanguageSelection=function(){var t=s.language,e=[{value:"en",text:"English"},{value:"es",text:"Español"}];for(var i in e)if(e[i].value==t)return void this.optionArray.push(new V(e,i))};const _=I;function P(t){this.text=t}function B(t,e){P.call(this,t),this.function_pointer=e}function U(t,e,i,o){P.call(this,t),this.options=e,this.selectedOption=i,this.attribute=o}function V(t,e){U.call(this,"language",t,e)}function N(){_.call(this),this.section="optionsMenu",this.addSelection("tileSize",[{value:e.minTileSize(),text:"little"},{value:e.mediumTileSize(),text:"medium"},{value:e.maxTileSize(),text:"big"}],"tileSize"),this.addLanguageSelection()}P.prototype.getText=function(t){return s.getText(t,this.text)},P.prototype.execute=function(){},P.prototype.nextOption=function(){},P.prototype.previousOption=function(){},B.prototype=Object.create(P.prototype),B.prototype.execute=function(){this.function_pointer()},U.prototype=Object.create(P.prototype),U.prototype.changeValue=function(){e[this.attribute]=this.options[this.selectedOption].value},U.prototype.nextOption=function(){this.selectedOption=(this.selectedOption+1)%this.options.length,this.changeValue()},U.prototype.previousOption=function(){this.selectedOption=(this.options.length+this.selectedOption-1)%this.options.length,this.changeValue()},U.prototype.getText=function(t){return"<- "+s.getText(t,this.text)+" : "+s.getText(t,this.options[this.selectedOption].text)+" ->"},V.prototype=Object.create(U.prototype),V.prototype.changeValue=function(){s.language=this.options[this.selectedOption].value},V.prototype.getText=function(t){return"<- "+s.getText(t,this.text)+" : "+this.options[this.selectedOption].text+" ->"},N.prototype=Object.create(_.prototype);const Y=N,X={resources:{},init:()=>{X.resources=Object.assign(X.getResourcesObject(),{MINERAL:100})},getResourcesObject:()=>{let t={construction:0};for(var e in v.resources)t[e]=0;return t},addResources:t=>{for(let e in t)X.resources[e]+=t[e]},removeResources:t=>{for(let e in t)X.resources[e]-=t[e]},checkAvailable:t=>{for(var e in t)if(t[e]>X.resources[e])return!1;return!0}},Q=X,G={list:{robot:[]},unitsWaiting:()=>G.list.robot.filter((t=>t.isWaiting())),addRobot:function(t){G.list.robot.push(t),Q.resources.construction++},reset:function(){G.list.robot=[]}},K=G;function Z(){this.nextState=null}Z.prototype.changeState=function(t){if(null!=this.nextState){this.nextState.select();var e=this.nextState;this.nextState=null,t.currentState=e,n.resetKeyboard()}},Z.prototype.update=function(){},Z.prototype.draw=function(){},Z.prototype.select=function(){};const $=Z;function J(t,e,i){$.call(this),this.worldMap=t,this.pos=e,this.tile=i,this.tile.building=this,this.level=1,this.turnsBuilt=0}J.prototype=Object.create($.prototype),J.prototype.getResources=Q.getResourcesObject,J.prototype.getCost=Q.getResourcesObject,J.prototype.turnsToBuild=null,J.prototype.draw=function(){this.worldMap.drawBackground(),this.worldMap.drawUnits()},J.prototype.update=function(t){n.mouse.mainWindowClicked&&this.unSelect()},J.prototype.select=function(){this.worldMap.centerView(this.pos.x,this.pos.y)},J.prototype.unSelect=function(){this.nextState=this.worldMap},J.prototype.texture=function(){return W.textures.buildings[this.type]};const tt=J;function et(t,e,i){tt.call(this,t,e,i)}et.prototype=Object.create(tt.prototype),et.prototype.type="mine",et.prototype.getResources=()=>Object.assign(tt.prototype.getResources.call(void 0),{MINERAL:10}),et.prototype.getCost=()=>Object.assign(tt.prototype.getResources.call(void 0),{MINERAL:100}),tt.prototype.turnsToBuild=4;const it=et,ot={buildings:[],queue:[],buildMine:function(t){let e,i=it.prototype.getCost();for(e in i)Q.resources[e]-=i[e];t.state="BUILD";var o=new it(t.worldMap,t.pos,t.getTile());ot.queue.push(o)},reset:function(){ot.buildings=[],ot.queue=[]}},nt=ot;function rt(t,e,i,o,n=5,r=5){this.left=t,this.top=e,this.width=i,this.height=o,this.marginLeft=n,this.marginTop=r}rt.prototype.advanceHor=function(){this.left+=this.width+this.marginLeft},rt.prototype.advanceVer=function(){this.top+=this.height+this.marginTop},rt.prototype.getRect=function(){return{x0:this.left,x1:this.left+this.width,y0:this.top,y1:this.top+this.height}};const st=rt;function at(t,e,i=!1){this.control=t,this.size=e,this.v=i,this.reset()}at.prototype.reset=function(){this.panel={back:null,btn:[]},this.lastPos=this.v?this.control.top:this.control.left},at.prototype.addButton=function(t){var e;e=this.v?new st(this.control.left,this.lastPos,this.control.width,this.size):new st(this.lastPos,this.control.top,this.size,this.control.height),t.control=e,this.lastPos+=this.size,this.panel.btn[this.panel.btn.length]=t},at.prototype.draw=function(){this.panel.btn.forEach((t=>{t.draw()}))},at.prototype.isClicked=function(){this.panel.btn.forEach((t=>{t.isClicked()}))};const lt=at,ht={pointInRectangle:(t,e)=>t.x>e.x0&&t.x<e.x1&&t.y>e.y0&&t.y<e.y1};function pt(t,e,i,o,n=!0){this.parent=t,this.control=e,this.backColor=i,o&&(this.click=o),this.enabled=n}pt.prototype.draw=function(){this.drawBackGround(),this.drawEnabled()},pt.prototype.drawBackGround=function(){e.context.fillStyle=this.backColor,e.context.fillRect(this.control.left,this.control.top,this.control.width,this.control.height)},pt.prototype.drawEnabled=function(){this.enabled||(e.context.fillStyle="#000",e.context.globalAlpha=.5,e.context.fillRect(this.control.left,this.control.top,this.control.width,this.control.height),e.context.globalAlpha=1)},pt.prototype.isClicked=function(){this.enabled&&ht.pointInRectangle(n.mouse,this.control.getRect())&&this.click()},pt.prototype.click=function(){};const ct=pt;function ut(t,e,i,o,n,r,s,a=!0){ct.call(this,t,e,i,s,a),this.section=o,this.text=n,this.textColor=r}ut.prototype=Object.create(ct.prototype),ut.prototype.getText=function(){return s.getText(this.section,this.text)},ut.prototype.drawText=function(){e.context.fillStyle=this.textColor,e.context.font=e.buttonFont;var t=this.getText(),i=e.fontHeight(),o=~~((this.control.width-e.context.measureText(t).width)/2),n=~~((this.control.height-i)/2)+i;e.context.fillText(t,this.control.left+o,this.control.top+n)},ut.prototype.draw=function(){ct.prototype.drawBackGround.call(this),this.drawText(),ct.prototype.drawEnabled.call(this)};const dt=ut,ft={};ft.control=new st(e.mainScreenWidth,e.topMenuHeight,e.rightMenuSize()),ft.panel=new lt(ft.control,e.verticalButtonSize,!0),ft.backCtrl=new st(e.mainScreenWidth,e.bottomOfMap()-e.verticalButtonSize,e.rightMenuSize(),e.verticalButtonSize),ft.back=new dt(null,ft.backCtrl,"#008","general","back",e.highlightColor,(function(){this.parent.unSelect()})),ft.draw=(t,i=null)=>{let o=e.context,n=e.topMenuHeight;o.fillStyle=e.backgroundColor,o.fillRect(e.mainScreenWidth,n,e.rightMenuSize(),e.bottomOfMap()-n),ft.panel.draw(),ft.back.draw()},ft.click=()=>{n.mouse.rightMenuClicked&&(ft.panel.isClicked(),ft.back.isClicked())},ft.configure=t=>{ft.panel.reset(),ft.back.parent=t,Object.keys(t.options).forEach((i=>{let o=t.options[i];o.isValid(t)&&ft.panel.addButton(new dt(t,null,"#008","general",o.text,e.highlightColor,o.click,o.isEnabled()))}))};const mt=ft,gt=function(t){let i=e.context;i.fillStyle=e.backgroundColor,i.fillRect(0,e.bottomOfMap(),e.mainScreenWidth,e.height-e.bottomOfMap())};var yt=(t,e)=>{var i,o=[];do{o.push(e),i=t.filter((t=>e.equals(t.pos))),e=!!i.length&&i[0].from.pos}while(e);return o},vt=(t,e)=>{for(let i=0;i<e.length;i++)if(t.equals(e[i]))return e[i];return!1},xt=(t,e)=>{for(let i=0;i<e.length;i++)if(t.equals(e[i].pos))return i;return-1},bt=(t,e)=>{var i=null,o=Number.MAX_VALUE;return e.forEach(((e,n)=>{e.score<o&&vt(e.pos,t)&&(i=e,o=e.score)})),i};const wt={find:function(t){return function(t,e,i){var o,n,r,s,a,l=[t],h=[],p=[],c=[],u=[];for(p.push({pos:t,score:t.movementCost()}),u.push({pos:t,score:i(t,e)});l.length>0;){if((a=bt(l,u)).pos.equals(e))return yt(h,a.pos);l=l.filter((t=>!t.equals(a.pos))),c.push(a.pos),a.pos.neighbors().forEach((t=>{vt(t,c)||(r=p.filter((t=>!a.pos.equals(t))),s=r[0].score+(a.pos,t.movementCost()),(-1==(n=xt(t,p))||p[n].score>s)&&(o=h.filter((t=>a.pos.equals(t.from))),o.length?o[0].pos=t:h.push({pos:t,from:a}),-1==n?(p.push({pos:t,score:s}),u.push({pos:t,score:s+i(t,e)})):(p[n].score=s,u[n].score=s+i(t,e)),vt(t,l)||l.push(t)))}))}return!1}(t.pos,t.goal,St)}};var St=(t,e)=>t.distance(e);const kt=wt;function Tt(t){$.call(this),this.city=t,this.state="WAIT",this.goal=null,this.worldMap=t.parent.parent,this.pos=new u(t.parent.pos.x,t.parent.pos.y,this.worldMap),this.route=null,this.remainingMoves=this.moveRange,this.remainingTurnsToBuild=this.turnsToBuild,t.parent.unit=this}Tt.prototype=Object.create($.prototype),Tt.prototype.type=null,Tt.prototype.moveRange=1,Tt.prototype.turnsToBuild=5,Tt.prototype.options={FORTIFY:{text:"fortify",click:function(){this.parent.state="FORTIFY",this.parent.unSelect()},isValid:t=>!0,isEnabled:t=>!0}},Tt.prototype.cost={MINERAL:50},Tt.prototype.refresh=function(){this.remainingMoves=this.moveRange},Tt.prototype.text=function(){return s.getText("units",this.type)},Tt.prototype.texture=function(){return W.textures.userResources[this.type]},Tt.prototype.isWaiting=function(){return"MOVE"==this.state&&this.move(),"WAIT"==this.state&&this.remainingMoves>0},Tt.prototype.goTo=function(t){this.goal=new u(t.x,t.y,this.worldMap),this.route=kt.find(this).reverse(),null==this.route||this.route.length<2||(this.state="MOVE",this.move())},Tt.prototype.move=function(){this.worldMap.map[this.pos.x][this.pos.y].unit=null;let t=this.remainingMoves<this.route.length?this.remainingMoves:this.route.length;this.route=this.route.slice(t),this.pos=this.route[0],this.remainingMoves-=t,this.worldMap.map[this.pos.x][this.pos.y].unit=this,this.pos.equals(this.goal)&&(this.state="WAIT")},Tt.prototype.getTile=function(){return this.worldMap.map[this.pos.x][this.pos.y]},Tt.prototype.select=function(){this.worldMap.centerView(this.pos.x,this.pos.y),mt.configure(this)},Tt.prototype.draw=function(){this.worldMap.drawBackground(),this.worldMap.drawUnits(this),mt.draw(this)},Tt.prototype.drawUnit=function(){let t=(this.pos.x-this.worldMap.topLeftX+this.worldMap.options.width)%this.worldMap.options.width,i=(this.pos.y-this.worldMap.topLeftY+this.worldMap.options.height)%this.worldMap.options.height;t<e.horizontalTilesToShow()&&i<e.verticalTilesToShow()&&e.context.drawImage(this.texture(),t*e.tileSize,i*e.tileSize+e.topMenuHeight,e.tileSize,e.tileSize)},Tt.prototype.drawSelectedUnit=function(){let t=e.context,i=t.globalAlpha;t.globalAlpha=Math.lerp(.5,1,l.gradient),this.drawUnit(),t.globalAlpha=i},Tt.prototype.update=function(t){n.mouse.mainWindowClicked&&(this.goTo(this.worldMap.getTile(n.mouse.x,n.mouse.y-e.topMenuHeight)),this.unSelect()),mt.click(this)},Tt.prototype.unSelect=function(){this.nextState=this.worldMap};const Mt=Tt;function Ct(t){Mt.call(this,t),this.life=this.maxLife}Ct.prototype=Object.create(Mt.prototype),Ct.prototype.type="robots",Ct.prototype.maxLife=100;const zt=Ct;function Rt(t){zt.call(this,t)}Rt.prototype=Object.create(zt.prototype),Rt.prototype.type="construction",Rt.prototype.options.MINE={text:"mine",click:function(){nt.buildMine(this.parent),this.parent.unSelect()},isValid:t=>{var e=t.getTile();return e.resource==v.resources.MINERAL&&!e.building},isEnabled:t=>Q.checkAvailable(it.prototype.getCost())};const Ot=Rt,Dt={constructionRobot:t=>new Ot(t)};function At(t){$.call(this),this.parent=t,this.context=e.context,this.queue=[]}At.prototype=Object.create($.prototype),At.prototype.options={ROBOT:{text:"construction",click:function(){this.parent.addToConstructionQueue(Dt.constructionRobot(this.parent))},isValid:t=>!0,isEnabled:t=>!0}},At.prototype.text=function(){return"city"},At.prototype.getResources=function(){return Object.assign(Q.getResourcesObject(),{MINERAL:5})},At.prototype.select=function(){this.parent.centerView(),mt.configure(this)},At.prototype.unSelect=function(){this.nextState=this.parent.parent},At.prototype.processTurn=function(){Q.addResources(this.getResources()),this.queue.length&&(this.queue[0].remainingTurnsToBuild--,this.queue[0].remainingTurnsToBuild<=0&&K.addRobot(this.queue.shift()))},At.prototype.addToConstructionQueue=function(t){Q.checkAvailable(t.cost)&&(Q.removeResources(t.cost),this.queue.push(t),this.unSelect())},At.prototype.removeFromConstructionQueue=function(){let t=this.parent.queue.pop();Q.addResources(t.cost)},At.prototype.update=function(){n.mouse.mainWindowClicked&&this.unSelect(),mt.click(this)},At.prototype.draw=function(){this.drawBackground(),mt.draw(),gt(this)},At.prototype.drawBackground=function(){this.parent.parent.draw(),this.context.globalAlpha=.5,this.context.fillStyle="#008",this.context.fillRect(0,e.topMenuHeight,e.mainScreenWidth,e.mainScreenHeight),this.context.globalAlpha=1};const qt=At,Et={cities:[],addCity:(t,i,o)=>{t.mapCanvas.getContext("2d").drawImage(W.textures.general.city,i*e.maxTileSize(),o*e.maxTileSize(),e.maxTileSize(),e.maxTileSize());var n=new qt(t.map[i][o]);return t.map[i][o].building=n,Et.cities.push(n),n},reset:()=>{Et.cities=[]}},Lt=Et,jt={turn:0,screen:null,advance:function(){var t=K.unitsWaiting();t.length?t[0].worldMap.nextState=t[0]:(Lt.cities.forEach((t=>t.processTurn())),nt.buildings.forEach((t=>Q.addResources(t.getResources()))),nt.queue.forEach((t=>{if("BUILD"==t.tile.unit.state&&t.tile.unit.remainingMoves>0){t.tile.unit.remainingMoves=0,t.turnsBuilt++;var i=t.worldMap.resourcesCanvas.getContext("2d");i.globalAlpha=t.turnsBuilt/t.turnsToBuild,i.clearRect(t.pos.x*e.maxTileSize(),t.pos.y*e.maxTileSize(),e.maxTileSize(),e.maxTileSize()),i.drawImage(t.texture(),t.pos.x*e.maxTileSize(),t.pos.y*e.maxTileSize(),e.maxTileSize(),e.maxTileSize()),i.globalAlpha=1,t.turnsBuilt==t.turnsToBuild&&(nt.buildings.push(t),t.tile.unit.state="WAIT")}})),nt.queue=nt.queue.filter((t=>t.turnsBuilt!=t.turnsToBuild)),jt.turn++,K.list.robot.forEach((t=>t.refresh())))},init:function(){jt.turn=0},reset:function(t){jt.turn=0,jt.screen=t}},Ft=jt;function Wt(t){[this.contributions2D,this.lookup2D]=this.createContributionArray(this.types._2D),[this.contributions3D,this.lookup3D]=this.createContributionArray(this.types._3D),[this.contributions4D,this.lookup4D]=this.createContributionArray(this.types._4D),this.perm=new Uint8Array(256),this.perm2D=new Uint8Array(256),this.perm3D=new Uint8Array(256),this.perm4D=new Uint8Array(256);var e=new Uint8Array(this.setOf(256,(t=>t)));this.seed=this.shuffleSeed(t,3),this.doFor(256,(t=>{t=255-t,this.seed=this.shuffleSeed(this.seed);var i=(this.seed+31)%(t+1);i+=i<0?t+1:0,this.perm[t]=e[i],this.perm2D[t]=14&this.perm[t],this.perm3D[t]=this.perm[t]%24*3,this.perm4D[t]=252&this.perm[t],e[i]=e[t]}))}Wt.prototype.SQ5=2.23606797749979,Wt.prototype.SQ4=2,Wt.prototype.SQ3=1.7320508075688772,Wt.prototype.toNums=t=>t.split(",").map((t=>new Uint8Array(t.split("").map((t=>Number(t)))))),Wt.prototype.decode=(t,e,i)=>new Int8Array(i.split("").map((i=>parseInt(i,e)+t))),Wt.prototype.toNumsB32=t=>t.split(",").map((t=>parseInt(t,32))),Wt.prototype.NORM_2D=1/47,Wt.prototype.NORM_3D=1/103,Wt.prototype.NORM_4D=1/30,Wt.prototype.SQUISH_2D=(Wt.prototype.SQ3-1)/2,Wt.prototype.SQUISH_3D=(Wt.prototype.SQ4-1)/3,Wt.prototype.SQUISH_4D=(Wt.prototype.SQ5-1)/4,Wt.prototype.STRETCH_2D=(1/Wt.prototype.SQ3-1)/2,Wt.prototype.STRETCH_3D=(1/Wt.prototype.SQ4-1)/3,Wt.prototype.STRETCH_4D=(1/Wt.prototype.SQ5-1)/4,Wt.prototype.base2D=Wt.prototype.toNums("110101000,110101211"),Wt.prototype.base3D=Wt.prototype.toNums("0000110010101001,2110210120113111,110010101001211021012011"),Wt.prototype.base4D=Wt.prototype.toNums("0000011000101001001010001,3111031101310113011141111,11000101001001010001211002101021001201102010120011,31110311013101130111211002101021001201102010120011"),Wt.prototype.gradients2D=Wt.prototype.decode(-5,11,"a77a073aa3700330"),Wt.prototype.gradients3D=Wt.prototype.decode(-11,23,"0ff7mf7fmmfffmfffm07f70f77mm7ff0ff7m0f77m77f0mf7fm7ff0077707770m77f07f70"),Wt.prototype.gradients4D=Wt.prototype.decode(-3,7,"6444464444644446044426442464244662444044426442460244204422642246642446244404442604242624240424266224402442044226022420242204222664424642446244400442264224622440624240424262424002422042226222406422462244024420042226222402242062224022420242200222202222022220"),Wt.prototype.lookupPairs2D=()=>new Uint8Array([0,1,1,0,4,1,17,0,20,2,21,2,22,5,23,5,26,4,39,3,42,4,43,3]),Wt.prototype.lookupPairs3D=()=>new Uint16Array(Wt.prototype.toNumsB32("0,2,1,1,2,2,5,1,6,0,7,0,10,2,12,2,41,1,45,1,50,5,51,5,g6,0,g7,0,h2,4,h6,4,k5,3,k7,3,l0,5,l1,5,l2,4,l5,3,l6,4,l7,3,l8,d,l9,d,la,c,ld,e,le,c,lf,e,m8,k,ma,i,p9,l,pd,n,q8,k,q9,l,15e,j,15f,m,16a,i,16e,j,19d,n,19f,m,1a8,f,1a9,h,1aa,f,1ad,h,1ae,g,1af,g,1ag,b,1ah,a,1ai,b,1al,a,1am,9,1an,9,1bg,b,1bi,b,1eh,a,1el,a,1fg,8,1fh,8,1qm,9,1qn,9,1ri,7,1rm,7,1ul,6,1un,6,1vg,8,1vh,8,1vi,7,1vl,6,1vm,7,1vn,6")),Wt.prototype.lookupPairs4D=()=>new Uint32Array(Wt.prototype.toNumsB32("0,3,1,2,2,3,5,2,6,1,7,1,8,3,9,2,a,3,d,2,g,3,i,3,m,1,n,1,o,3,q,3,11,2,15,2,16,1,17,1,19,2,1d,2,1m,1,1n,1,1o,0,1p,0,1q,0,1r,0,1s,0,1t,0,1u,0,1v,0,80,3,82,3,88,3,8a,3,8g,3,8i,3,8o,3,8q,3,201,2,205,2,209,2,20d,2,211,2,215,2,219,2,21d,2,280,9,281,9,288,9,289,9,g06,1,g07,1,g0m,1,g0n,1,g16,1,g17,1,g1m,1,g1n,1,g82,8,g86,8,g8i,8,g8m,8,i05,6,i07,6,i15,6,i17,6,i80,9,i81,9,i82,8,i85,6,i86,8,i87,6,i88,9,i89,9,i8i,8,i8m,8,i95,6,i97,6,401o,0,401p,0,401q,0,401r,0,401s,0,401t,0,401u,0,401v,0,408o,7,408q,7,409o,7,409q,7,4219,5,421d,5,421p,5,421t,5,4280,9,4281,9,4288,9,4289,9,428o,7,428q,7,4299,5,429d,5,429o,7,429p,5,429q,7,429t,5,4g1m,4,4g1n,4,4g1u,4,4g1v,4,4g82,8,4g86,8,4g8i,8,4g8m,8,4g8o,7,4g8q,7,4g9m,4,4g9n,4,4g9o,7,4g9q,7,4g9u,4,4g9v,4,4i05,6,4i07,6,4i15,6,4i17,6,4i19,5,4i1d,5,4i1m,4,4i1n,4,4i1p,5,4i1t,5,4i1u,4,4i1v,4,4i80,9,4i81,9,4i82,8,4i85,6,4i86,8,4i87,6,4i88,9,4i89,9,4i8i,8,4i8m,8,4i8o,7,4i8q,7,4i95,6,4i97,6,4i99,5,4i9d,5,4i9m,4,4i9n,4,4i9o,7,4i9p,5,4i9q,7,4i9t,5,4i9u,4,4i9v,4,4ia0,15,4ia1,15,4ia2,14,4ia5,12,4ia6,14,4ia7,12,4ia8,15,4ia9,15,4iai,14,4iam,14,4iao,13,4iaq,13,4ib5,12,4ib7,12,4ib9,11,4ibd,11,4ibm,10,4ibn,10,4ibo,13,4ibp,11,4ibq,13,4ibt,11,4ibu,10,4ibv,10,4ii0,1h,4ii2,1g,4ii8,1h,4iii,1g,4iio,1f,4iiq,1f,4ka1,1e,4ka5,1d,4ka9,1e,4kb5,1d,4kb9,1c,4kbd,1c,4ki0,1h,4ki1,1e,4ki8,1h,4ki9,1e,52a6,1b,52a7,1a,52am,1b,52b7,1a,52bm,19,52bn,19,52i2,1g,52i6,1b,52ii,1g,52im,1b,54a5,1d,54a7,1a,54b5,1d,54b7,1a,54i0,v,54i1,s,54i2,v,54i5,s,54i6,p,54i7,p,8ibo,18,8ibp,17,8ibq,18,8ibt,17,8ibu,16,8ibv,16,8iio,1f,8iiq,1f,8ijo,18,8ijq,18,8kb9,1c,8kbd,1c,8kbp,17,8kbt,17,8ki8,u,8ki9,r,8kio,u,8kj9,r,8kjo,m,8kjp,m,92bm,19,92bn,19,92bu,16,92bv,16,92ii,t,92im,o,92iq,t,92jm,o,92jq,l,92ju,l,94b5,q,94b7,n,94bd,q,94bn,n,94bt,k,94bv,k,94i0,v,94i1,s,94i2,v,94i5,s,94i6,p,94i7,p,94i8,u,94i9,r,94ii,t,94im,o,94io,u,94iq,t,94j5,q,94j7,n,94j9,r,94jd,q,94jm,o,94jn,n,94jo,m,94jp,m,94jq,l,94jt,k,94ju,l,94jv,k,94k0,1t,94k1,1s,94k2,1t,94k5,1s,94k6,1r,94k7,1r,94k8,1q,94k9,1p,94ki,1n,94km,1m,94ko,1q,94kq,1n,94l5,1k,94l7,1j,94l9,1p,94ld,1k,94lm,1m,94ln,1j,94lo,1o,94lp,1o,94lq,1l,94lt,1i,94lu,1l,94lv,1i,94s0,1t,94s2,1t,94s8,1q,94si,1n,94so,1q,94sq,1n,96k1,1s,96k5,1s,96k9,1p,96l5,1k,96l9,1p,96ld,1k,96s0,2f,96s1,2f,96s8,2c,96s9,2c,9kk6,1r,9kk7,1r,9kkm,1m,9kl7,1j,9klm,1m,9kln,1j,9ks2,2e,9ks6,2e,9ksi,29,9ksm,29,9mk5,2d,9mk7,2d,9ml5,26,9ml7,26,9ms0,2f,9ms1,2f,9ms2,2e,9ms5,2d,9ms6,2e,9ms7,2d,d4lo,1o,d4lp,1o,d4lq,1l,d4lt,1i,d4lu,1l,d4lv,1i,d4so,2b,d4sq,28,d4to,2b,d4tq,28,d6l9,2a,d6ld,25,d6lp,2a,d6lt,25,d6s8,2c,d6s9,2c,d6so,2b,d6t9,2a,d6to,2b,d6tp,2a,dklm,27,dkln,24,dklu,27,dklv,24,dksi,29,dksm,29,dksq,28,dktm,27,dktq,28,dktu,27,dml5,26,dml7,26,dmld,25,dmln,24,dmlt,25,dmlv,24,dms0,23,dms1,23,dms2,22,dms5,20,dms6,22,dms7,20,dms8,23,dms9,23,dmsi,22,dmsm,22,dmso,21,dmsq,21,dmt5,20,dmt7,20,dmt9,1v,dmtd,1v,dmtm,1u,dmtn,1u,dmto,21,dmtp,1v,dmtq,21,dmtt,1v,dmtu,1u,dmtv,1u,dmu0,j,dmu1,j,dmu2,i,dmu5,g,dmu6,i,dmu7,g,dmu8,j,dmu9,j,dmui,i,dmum,i,dmuo,h,dmuq,h,dmv5,g,dmv7,g,dmv9,f,dmvd,f,dmvm,e,dmvn,e,dmvo,h,dmvp,f,dmvq,h,dmvt,f,dmvu,e,dmvv,e,dn60,j,dn61,j,dn62,i,dn66,i,dn68,j,dn69,j,dn6i,i,dn6m,i,dn6o,h,dn6q,h,dn7o,h,dn7q,h,dou0,j,dou1,j,dou5,g,dou7,g,dou8,j,dou9,j,dov5,g,dov7,g,dov9,f,dovd,f,dovp,f,dovt,f,dp60,j,dp61,j,dp68,j,dp69,j,e6u2,i,e6u5,g,e6u6,i,e6u7,g,e6ui,i,e6um,i,e6v5,g,e6v7,g,e6vm,e,e6vn,e,e6vu,e,e6vv,e,e762,i,e766,i,e76i,i,e76m,i,e8u5,g,e8u7,g,e8v5,g,e8v7,g,e960,d,e961,d,e962,d,e963,d,e964,d,e965,d,e966,d,e967,d,hmuo,h,hmuq,h,hmv9,f,hmvd,f,hmvm,e,hmvn,e,hmvo,h,hmvp,f,hmvq,h,hmvt,f,hmvu,e,hmvv,e,hn6o,h,hn6q,h,hn7o,h,hn7q,h,hov9,f,hovd,f,hovp,f,hovt,f,hp68,c,hp69,c,hp6o,c,hp6p,c,hp78,c,hp79,c,hp7o,c,hp7p,c,i6vm,e,i6vn,e,i6vu,e,i6vv,e,i76i,b,i76m,b,i76q,b,i76u,b,i77i,b,i77m,b,i77q,b,i77u,b,i8v5,a,i8v7,a,i8vd,a,i8vf,a,i8vl,a,i8vn,a,i8vt,a,i8vv,a,i960,d,i961,d,i962,d,i963,d,i964,d,i965,d,i966,d,i967,d,i968,c,i969,c,i96i,b,i96m,b,i96o,c,i96p,c,i96q,b,i96u,b,i975,a,i977,a,i978,c,i979,c,i97d,a,i97f,a,i97i,b,i97l,a,i97m,b,i97n,a,i97o,c,i97p,c,i97q,b,i97t,a,i97u,b,i97v,a")),Wt.prototype.p2D=Wt.prototype.decode(-1,4,"112011021322233123132111"),Wt.prototype.p3D=Wt.prototype.decode(-1,5,"112011210110211120110121102132212220132122202131222022243214231243124213241324123222113311221213131221123113311112202311112022311112220342223113342223311342223131322023113322023311320223113320223131322203311322203131"),Wt.prototype.p4D=Wt.prototype.decode(-1,6,"11201112101121101102111120111210110121110211112011011211012111021322112220122210132121220212212013122120221212201321122201222102131212202122120213112220122210222532215232152231253212523125221325312252132521232513225123251223232211432114231123212143121421312312214132141231232112431124211323121241312412132311224113241123342221322203311134221232202331113421223202233111342221322203131134221232202313113412223022231311342221322203113134212232022311313412223022231131342212322023111334212232022311133412223022231113322201222101111132202122120111113202212122011111322012221021111132021221202111113201222102211111322201222103311132202122120331113220122210233111322201222103131132022121220313113202122120231311322021221203113132022121220311313201222102231131322012221023111332021221202311133201222102231113422111331113222042121131311322204211213113132220422111331113220242121131311322024211123111332202422111331113202242112131131320224211123111332022421211313113022242112131131302224211123111330222443211423115222244312142131522224413214123152222443112421135222244131241213522224411324112352222443211423113222044312142131322204413214123132220443211423113220244311242113322024413124121332202443121421313202244311242113320224411324112332022441321412313022244131241213302224411324112330222"),Wt.prototype.setOf=(t,e=(t=>t))=>{for(var i=[],o=0;o<t;)i.push(e(o++));return i},Wt.prototype.doFor=(t,e)=>{for(var i=0;i<t&&!0!==e(i++););},Wt.prototype.types={_2D:{base:Wt.prototype.base2D,squish:Wt.prototype.SQUISH_2D,dimensions:2,pD:Wt.prototype.p2D,lookup:Wt.prototype.lookupPairs2D},_3D:{base:Wt.prototype.base3D,squish:Wt.prototype.SQUISH_3D,dimensions:3,pD:Wt.prototype.p3D,lookup:Wt.prototype.lookupPairs3D},_4D:{base:Wt.prototype.base4D,squish:Wt.prototype.SQUISH_4D,dimensions:4,pD:Wt.prototype.p4D,lookup:Wt.prototype.lookupPairs4D}},Wt.prototype.shuffleSeed=function(t,e=1){return t=1664525*t+1013904223|0,(e-=1)>0?this.shuffleSeed(t,e):t},Wt.prototype.createContribution=function(t,e,i){var o=0;const n=e[i++],r={next:void 0};for(;o<t.dimensions;){const s="xyzw"[o];r[s+"sb"]=e[i+o],r["d"+s]=-e[i+o++]-n*t.squish}return r},Wt.prototype.createLookupPairs=function(t,e){var i;const o=t(),n=new Map;for(i=0;i<o.length;i+=2)n.set(o[i],e[o[i+1]]);return n},Wt.prototype.createContributionArray=function(t){const e=[],i=t.dimensions,o=i*i;for(var n,r=0;r<t.pD.length;){const s=t.base[t.pD[r]];let a,l;n=0;do{l=this.createContribution(t,s,n),a?a.next=l:e[r/o]=l,a=l,n+=i+1}while(n<s.length);l.next=this.createContribution(t,t.pD,r+1),i>=3&&(l.next.next=this.createContribution(t,t.pD,r+i+2)),4===i&&(l.next.next.next=this.createContribution(t,t.pD,r+11)),r+=o}return[e,this.createLookupPairs(t.lookup,e)]},Wt.prototype.noise2D=function(t,e){const i=this.perm2D,o=this.perm,n=this.gradients2D,r=(t+e)*this.STRETCH_2D,s=t+r,a=e+r,l=Math.floor(s),h=Math.floor(a),p=(l+h)*this.SQUISH_2D,c=t-(l+p),u=e-(h+p);for(var d,f=(()=>{const t=s-l,e=a-h,i=t+e;return this.lookup2D.get(t-e+1|i<<1|i+e<<2|i+t<<4)})(),m=0;void 0!==f;){const t=c+f.dx,e=u+f.dy;let r=2-t*t-e*e;r>0&&(d=i[o[l+f.xsb&255]+(h+f.ysb)&255],r*=r,m+=r*r*(n[d++]*t+n[d]*e)),f=f.next}return m*this.NORM_2D},Wt.prototype.noise3D=function(t,e,i){const o=this.perm3D,n=this.perm,r=this.gradients3D,s=(t+e+i)*this.STRETCH_3D,a=t+s,l=e+s,h=i+s,p=Math.floor(a),c=Math.floor(l),u=Math.floor(h),d=(p+c+u)*this.SQUISH_3D,f=t-(p+d),m=e-(c+d),g=i-(u+d);for(var y,v=(()=>{const t=a-p,e=l-c,i=h-u,o=t+e+i;return this.lookup3D.get(e-i+1|t-e+1<<1|t-i+1<<2|o<<3|o+i<<5|o+e<<7|o+t<<9)})(),x=0;void 0!==v;){const t=f+v.dx,e=m+v.dy,i=g+v.dz;let s=2-t*t-e*e-i*i;s>0&&(y=o[(n[p+v.xsb&255]+(c+v.ysb)&255)+(u+v.zsb)&255],s*=s,x+=s*s*(r[y++]*t+r[y++]*e+r[y]*i)),v=v.next}return x*this.NORM_3D},Wt.prototype.noise4D=function(t,e,i,o){const n=this.perm4D,r=this.perm,s=this.gradients4D,a=(t+e+i+o)*this.STRETCH_4D,l=t+a,h=e+a,p=i+a,c=o+a,u=Math.floor(l),d=Math.floor(h),f=Math.floor(p),m=Math.floor(c),g=(u+d+f+m)*this.SQUISH_4D,y=t-(u+g),v=e-(d+g),x=i-(f+g),b=o-(m+g);for(var w,S=(()=>{const t=l-u,e=h-d,i=p-f,o=c-m,n=t+e+i+o;return this.lookup4D.get(i-o+1|e-i+1<<1|e-o+1<<2|t-e+1<<3|t-i+1<<4|t-o+1<<5|n<<6|n+o<<8|n+i<<11|n+e<<14|n+t<<17)})();void 0!==S;){const t=y+S.dx,e=v+S.dy,i=x+S.dz,o=b+S.dw;let a=2-t*t-e*e-i*i-o*o;a>0&&(w=n[((r[u+S.xsb&255]+(d+S.ysb)&255)+(f+S.zsb)&255)+(m+S.wsb)&255],a*=a,s[w++],s[w++],s[w++],s[w]),S=S.next}};const Ht=Wt,It={generate:function(t){It.generateWorld(t),It.generateStartingPoint(t),v.generateResources(t)},generateWorld:function(t){var i=document.createElement("canvas");i.width=t.options.width*e.maxTileSize(),i.height=t.options.height*e.maxTileSize();for(var o,n,r,s,a,l,h,p,c,u=i.getContext("2d"),d=new Ht(1),m=.04+.05*Math.random(),g=.075+.05*Math.random(),y=2*Math.PI/t.options.width,v=t.options.width/8,x=0,b=new Array(t.options.width),w=0;w<t.options.width;w++){b[w]=new Array(t.options.height),p=v*Math.sin(x),c=v*Math.cos(x),o=m*p+t.options.heightSeedX,n=m*c+t.options.heightSeedZ,r=g*p+t.options.humiditySeedX,s=g*c+t.options.humiditySeedZ;for(var S=0;S<t.options.height;S++)a=d.noise3D(o,S*m+t.options.heightSeedY,n),l=d.noise3D(r,S*g+t.options.humiditySeedY,s),h=new f(t,a,l,w,S),b[w][S]=h,u.drawImage(W.textures.mapTile[h.type],w*e.maxTileSize(),S*e.maxTileSize(),e.maxTileSize(),e.maxTileSize()),t.stats[h.type]+=1;x+=y}t.map=b,t.mapCanvas=i;var k=document.createElement("canvas");k.width=i.width,k.height=i.height,t.resourcesCanvas=k},generateStartingPoint:function(t){var e,i;do{e=~~(Math.random()*t.options.width),i=15+~~(Math.random()*(t.options.height-30))}while("grass"!=t.map[e][i].type);let o=Lt.addCity(t,e,i);K.addRobot(Dt.constructionRobot(o)),t.startingPointX=e,t.startingPointY=i,t.centerViewonStartingPoint()},generateOptions:function(t){var e=24+~~(15*Math.random()),i={};return i.width=4*e,i.height=3*e,"normal"==t.type&&(i.waterHeight=.35+.2*Math.random(),i.heightSeedX=Math.random(),i.heightSeedY=Math.random(),i.heightSeedZ=Math.random(),i.humiditySeedX=Math.random(),i.humiditySeedY=Math.random(),i.humiditySeedZ=Math.random()),i}},_t=It,Pt={normalMapView:function(t){var i=e.context,o=e.horizontalTilesToShow(),n=e.verticalTilesToShow(),r=t.topLeftX*e.maxTileSize(),s=t.topLeftY*e.maxTileSize(),a=o*e.maxTileSize(),l=n*e.maxTileSize(),h=0,p=e.topMenuHeight,c=e.mainScreenWidth,u=e.mainScreenHeight,d=t.options.width-t.topLeftX;i.drawImage(t.mapCanvas,r,s,a,l,h,p,c,u),i.drawImage(t.resourcesCanvas,r,s,a,l,h,p,c,u),d<o&&(r=0,h=d*e.tileSize,i.drawImage(t.mapCanvas,r,s,a,l,h,p,c,u),i.drawImage(t.resourcesCanvas,r,s,a,l,h,p,c,u))},heightMapView:function(t){var i,o,n,r,s,a=e.context,l=e.horizontalTilesToShow(),h=e.verticalTilesToShow();for(i=0;i<l;i++)for(r=i*e.tileSize,o=0;o<h;o++)s=o*e.tileSize+e.topMenuHeight,n=t.map[(t.topLeftX+i)%t.options.width][(t.topLeftY+o)%t.options.height],a.fillStyle=n.heightGray(),a.fillRect(r,s,e.tileSize,e.tileSize)},humidityMapView:function(t){var i,o,n,r,s,a=e.context,l=e.horizontalTilesToShow(),h=e.verticalTilesToShow();for(i=0;i<l;i++)for(r=i*e.tileSize,o=0;o<h;o++)s=o*e.tileSize+e.topMenuHeight,n=t.map[(t.topLeftX+i)%t.options.width][(t.topLeftY+o)%t.options.height],a.fillStyle=n.humidityGray(),a.fillRect(r,s,e.tileSize,e.tileSize)},blockMapView:function(t){var i,o,n,r,s,a=e.context,l=e.horizontalTilesToShow(),h=e.verticalTilesToShow();for(i=0;i<l;i++)for(r=i*e.tileSize,o=0;o<h;o++)s=o*e.tileSize+e.topMenuHeight,n=t.map[(t.topLeftX+i)%t.options.width][(t.topLeftY+o)%t.options.height],a.fillStyle=n.mapColor(),a.fillRect(r,s,e.tileSize,e.tileSize)}};Pt.drawArray=[Pt.normalMapView,Pt.heightMapView,Pt.humidityMapView,Pt.blockMapView];const Bt=Pt;function Ut(t,e,i,o,n){!function(t,e,i,o){t.drawImage(W.textures[i][o],e.left,e.top,e.width,e.height),e.left+=e.width}(e,i,o,n),Vt(Q.resources[n],e,i),i.advanceHor()}function Vt(t,e,i){e.fillText(t,i.left,i.top+12)}const Nt={draw:function(t){var i=new st(5,5,15,15),o=e.context;for(var n in o.fillStyle=e.textColor,o.font=e.normalFont,Ut(0,o,i,"userResources","construction"),v.resources)Ut(0,o,i,"naturalResources",n);i.left=e.mainScreenWidth,Vt("T "+Ft.turn,o,i)}},Yt=function(t){if(t){var i=e.context;i.fillStyle=e.textColor,i.font=e.normalFont;var o,n,r=e.fontHeight();o=e.bottomOfMap()+e.topMenuHeight,n=t.type,i.fillText(n,15,o),o+=r,n="Height: "+t.height,i.fillText(n,15,o),o+=r,n="Humidity: "+t.humiditySeed,i.fillText(n,15,o),t.resource&&(o+=r,n=s.getText("resources",t.resource.text),i.fillText(n,15,o))}},Xt={init:()=>{var t=e.bottomOfMap()-e.verticalButtonSize,i=new st(e.mainScreenWidth,t,e.rightMenuSize(),e.verticalButtonSize);Xt.nextTurnBtn=new dt(Xt,i,"#008","general","nextTurn",e.highlightColor,(()=>{Ft.advance()}))},draw:t=>{let i=e.context,o=e.topMenuHeight;i.fillStyle=e.backgroundColor,i.fillRect(e.mainScreenWidth,o,e.rightMenuSize(),e.bottomOfMap()-o),o=e.topMenuHeight,Xt.nextTurnBtn.draw()},mouseClick:()=>{Xt.nextTurnBtn.isClicked()}},Qt=Xt,Gt={draw:function(t){var i=e.context;i.drawImage(t.mapCanvas,e.mainScreenWidth,e.bottomOfMap(),e.width-e.mainScreenWidth,e.height-e.bottomOfMap());var o=e.rightMenuSize()/t.options.width,n=e.lowerMenuSize()/t.options.height,r=e.mainScreenWidth+t.topLeftX*o,s=e.bottomOfMap()+t.topLeftY*n,a=e.horizontalTilesToShow()*o,h=e.verticalTilesToShow()*n,p=Math.lerp(.7,1,l.gradient);i.strokeStyle="rgba(0,0,0,"+p+")",i.strokeRect(r,s,a,h);var c=r+a-e.width;c>0&&i.strokeRect(e.mainScreenWidth,s,c,h)},mouseClick:function(t,i,o){t.centerView(~~(i/e.rightMenuSize()*t.options.width),~~(o/e.lowerMenuSize()*t.options.height))}},Kt=Gt,Zt=function(t,i){const o=e.context;if(o.fillStyle=e.backgroundColor,o.fillRect(i,e.topMenuHeight,e.width-i,e.height-e.topMenuHeight),t){const n=20;let r=i+n,s=e.topMenuHeight+n;o.fillStyle=e.textColor,o.font=e.buttonFont,o.fillText(t.name,r,s),s+=n,o.fillText(`Cost: ${t.cost}`,r,s)}};function $t(t){$.call(this),this.parent=t,this.clickedTech=null}$t.prototype=Object.create($.prototype),$t.prototype.sx=0,$t.prototype.sy=0,$t.prototype.update=function(){W.textures.research.tree,n.keyboard.ARROW_LEFT.execute()&&this.moveLeft(),n.keyboard.ARROW_RIGHT.execute()&&this.moveRight(),n.keyboard.ARROW_DOWN.execute()&&this.moveDown(),n.keyboard.ARROW_UP.execute()&&this.moveUp(),n.keyboard.T.execute()&&(this.nextState=this.parent),n.mouse.isClicked&&this.mouseClick()},$t.prototype.mouseClick=function(){this.clickedTech=function(t,e,i,o){let n,r=[b.root],s=[];for(;r.length>0;){if(n=r.shift(),s.push(n),t+i>n.pos.x&&t+i<n.pos.x+b.iconSize&&e+o>n.pos.y&&e+o<n.pos.y+b.iconSize)return n;for(let t in n.children){let e=n.children[t];s.includes(e)||r.includes(e)||r.push(e)}}return null}(n.mouse.x,n.mouse.y-e.topMenuHeight,this.sx,this.sy)},$t.prototype.moveLeft=function(){this.sx-=10,this.sx<0&&(this.sx=0)},$t.prototype.moveRight=function(){let t=W.textures.research.tree.width-e.mainScreenWidth;t<0||(this.sx+=10,this.sx>t&&(this.sx=t))},$t.prototype.moveUp=function(){this.sy-=10,this.sy<0&&(this.sy=0)},$t.prototype.moveDown=function(){let t=W.textures.research.tree.height-e.height+e.topMenuHeight;t<0||(this.sy+=10,this.sy>t&&(this.sy=t))},$t.prototype.draw=function(){const t=e.context;if(t.drawImage(W.textures.research.tree,this.sx,this.sy,e.mainScreenWidth,e.height-e.topMenuHeight,0,e.topMenuHeight,e.mainScreenWidth,e.height-e.topMenuHeight),this.clickedTech){const i=W.textures.research[this.clickedTech.name];t.filter="brightness(1)",t.drawImage(i,0,0,i.width,i.height,this.clickedTech.pos.x-this.sx,e.topMenuHeight+this.clickedTech.pos.y-this.sy,b.iconSize,b.iconSize),t.filter=null}Zt(this.clickedTech,W.textures.research.tree.width)};const Jt=$t;function te(t,e){for(var i in $.call(this),this.options=t,this.parent=e,this.stats=[],f.prototype.tileTypes)this.stats[i]=0;_t.generate(this),this.tileClicked=null,this.superiorSideTile=null,this.typeOfView=0,Qt.init()}te.prototype=Object.create($.prototype),te.prototype.draw=function(){var t=e.context;t.fillStyle=e.backgroundColor,t.fillRect(0,0,e.width,e.height),this.drawBackground(),this.drawUnits(),Yt(this.getTileClicked()),Nt.draw(this),Qt.draw(this),Kt.draw(this)},te.prototype.drawBackground=function(){Bt.drawArray[this.typeOfView](this)},te.prototype.drawUnits=function(t=null){K.list.robot.forEach((e=>{t==e?e.drawSelectedUnit():e.drawUnit()}))},te.prototype.update=function(t){n.keyboard.ARROW_LEFT.execute()&&this.moveLeft(),n.keyboard.ARROW_RIGHT.execute()&&this.moveRight(),n.keyboard.ARROW_UP.execute()&&this.moveUp(),n.keyboard.ARROW_DOWN.execute()&&this.moveDown(),n.keyboard.V.execute()&&this.changeView(),n.keyboard.C.execute()&&this.centerViewonStartingPoint(),n.keyboard.T.execute()&&(this.nextState=new Jt(this)),n.keyboard.SPACE.execute()&&Ft.advance(),n.mouse.mainWindowClicked&&this.mouseClick(n.mouse.x,n.mouse.y-e.topMenuHeight),n.mouse.miniMapClicked&&Kt.mouseClick(this,n.mouse.x-e.mainScreenWidth,n.mouse.y-e.bottomOfMap()),n.mouse.rightMenuClicked&&Qt.mouseClick()},te.prototype.getTile=function(t,i){return{x:(~~(t/e.tileSize)+this.topLeftX)%this.options.width,y:(~~(i/e.tileSize)+this.topLeftY)%this.options.height}},te.prototype.mouseClick=function(t,i){this.tileClicked=this.getTile(t,i),this.superiorSideTile=(i-(this.tileClicked.y-this.topLeftY)*e.tileSize)/e.tileSize<.5,this.nextState=this.getTileClicked().getState()},te.prototype.moveLeft=function(){this.topLeftX=(this.options.width+this.topLeftX-1)%this.options.width},te.prototype.moveRight=function(){this.topLeftX=(this.topLeftX+1)%this.options.width},te.prototype.moveUp=function(){this.topLeftY>0&&(this.topLeftY=this.topLeftY-1)},te.prototype.moveDown=function(){this.topLeftY+e.verticalTilesToShow()<this.options.height&&(this.topLeftY=this.topLeftY+1)},te.prototype.changeView=function(){this.typeOfView=(this.typeOfView+1)%Bt.drawArray.length},te.prototype.getTileClicked=function(){return this.tileClicked?this.map[this.tileClicked.x][this.tileClicked.y]:null},te.prototype.centerView=function(t,i){this.topLeftX=(~~(t-e.horizontalTilesToShow()/2)+this.options.width)%this.options.width,this.topLeftY=~~(i-e.verticalTilesToShow()/2),this.topLeftY<0?this.topLeftY=0:this.topLeftY+e.verticalTilesToShow()>this.options.height&&(this.topLeftY=this.options.height-e.verticalTilesToShow())},te.prototype.centerViewonStartingPoint=function(){this.centerView(this.startingPointX,this.startingPointY)};const ee=te;function ie(){Ft.reset(this),Q.init(),K.reset(),nt.reset(),b.reset(),this.totalTime=0,this.worldMap=new ee(_t.generateOptions({type:"normal"}),this),this.currentState=this.worldMap}ie.prototype.update=function(t){if(this.totalTime+=t,n.keyboard.O.execute())return H.addScreen(new Y),void n.resetKeyboard();n.keyboard.ESC.execute()&&(this.currentState==this.worldMap?H.removeScreen():this.currentState.nextState=this.worldMap,n.resetKeyboard()),this.currentState.changeState(this),this.currentState.update(t)},ie.prototype.draw=function(){this.currentState.draw()};const oe=ie;function ne(){_.call(this),this.section="mainMenu",this.addButton("start",(function(){H.addScreen(new oe)})),this.addButton("options",(function(){H.addScreen(new Y)}))}ne.prototype=Object.create(_.prototype);const re=ne;var se=0;function ae(t){var i=t-se;se=t,l.updateGradient(t),H.draw(),H.update(i),n.mouse.reset(),!e.hasToExit&&H.screenExists()?window.requestAnimationFrame(ae):console.log("Game over")}window.onload=function(){e.hasToExit=!1,l.readUserLanguage(),W.load();var t=document.getElementById("main_canvas");e.context=t.getContext("2d"),n.init(),document.onkeydown=function(t){n.keyDown(t.keyCode)},t.addEventListener("mousedown",(e=>{n.mouseDown(e.pageX-t.offsetLeft,e.pageY-t.offsetTop)})),t.addEventListener("mouseup",(e=>{n.mouseUp(e.pageX-t.offsetLeft,e.pageY-t.offsetTop)})),t.addEventListener("mousemove",(e=>{n.mouseMove(e.pageX-t.offsetLeft,e.pageY-t.offsetTop)})),H.addScreen(new re),window.requestAnimationFrame(ae)}})();